<div class="root f-col">

	<!-- BREADCRUMB-->
	<div class="crumbrow f-row">
        <div class="display-heading-large">Dashboard Builder</div>
        <div class="f-spacer"></div>
        <button *ngIf="collaboratorPermission && reportId"  matTooltip="Collaborator" mat-stroked-button [routerLink]="['', { outlets: { sb: 'sb/report/collaborators/' + reportId } } ]"><mat-icon>group_add</mat-icon></button>
        <div class="f-col-spacer-half"></div>
    </div>
    
    <mat-card class="mat-elevation-z3 builder-container">
        <mat-toolbar class="builder-toolbar">
            <mat-toolbar-row>
                <pros-form-input [type]="'text'" [placeholder]="'Untitled-1'" [label]="'Dashboard Name'" [value]="reportName" 
                    (valueChange)="(setreportname($event))">
                </pros-form-input>

                <span class="f-spacer"></span>

                <button mat-flat-button color="primary" (click)="createUpdateReport()">Save Changes</button>

                <span class="f-col-spacer-half"></span>
                <mat-button-toggle-group>
                <mat-button-toggle matTooltip="Coming soon..">
                    <mat-icon>view_compact</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle matTooltip="Coming soon..">
                    <mat-icon>zoom_out_map</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle matTooltip="Coming soon..">
                    <mat-icon>chrome_reader_mode</mat-icon>
                </mat-button-toggle>
                </mat-button-toggle-group>
            </mat-toolbar-row>
        </mat-toolbar>

        <div class="f-row container-row">
            <mat-card class="mat-elevation-z0 widget-col">
                <mat-card-content>
                    <mat-accordion>
                        <mat-expansion-panel class="mat-elevation-z2" expanded="true">
                          <mat-expansion-panel-header>
                            <mat-panel-title>
                              New Widget
                            </mat-panel-title>
                          </mat-expansion-panel-header>
                          <mat-list role="list" cdkDropList cdkDropListConnectedTo="container">
                            <mat-list-item role="listitem" cdkDrag widgetType="FILTER"><pros-svg-icon size="20" icon="FILTER_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Filter</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="COUNT"><pros-svg-icon size="20" icon="COUNT_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Metric</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="TABLE_LIST"><pros-svg-icon size="20" icon="LIST_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Table List</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="BAR_CHART"><pros-svg-icon size="20" icon="BAR_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Bar/Pie Chart</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="STACKED_BAR_CHART"><pros-svg-icon size="20" icon="STACKEDBAR_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Stacked Bar Chart</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="IMAGE"><pros-svg-icon size="20" icon="IMAGE_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Image</mat-list-item>
                            <mat-divider></mat-divider>
                            <mat-list-item role="listitem" cdkDrag widgetType="HTML"><pros-svg-icon size="20" icon="HTML_WIDGET" class="svg-widgetdrag" color="widget"></pros-svg-icon>Html Editor</mat-list-item>
                          </mat-list>

                        </mat-expansion-panel>
                    </mat-accordion>
                    <mat-accordion>
                        <mat-expansion-panel class="mat-elevation-z2">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                Available Widget
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <p>Coming soon...</p>
                          </mat-expansion-panel>
                    </mat-accordion>
                </mat-card-content>  
            </mat-card>

            <mat-card class="mat-elevation-z0 container-show builder-board" [ngStyle]="containerCss" [class.adjust-property] ="showProperty"  id="container" cdkDragBoundary cdkDropList (cdkDropListDropped)="drop($event)">    
                <ng-template ngFor let-widget [ngForOf]="widgetList">
                    <pros-dynamic-widget
                    [widget]="widget"
                    [boxSize]="eachBoxSize"
                    (evtDelete)="delete($event)"
                    (evtStyle) ="showStyle($event)"
                    >
                    </pros-dynamic-widget>
                </ng-template>
            </mat-card>

            <mat-card class="mat-elevation-z0 property-col" *ngIf="showProperty">
                <mat-toolbar class="c-toolbar-row">
                    <mat-toolbar-row>
                      <h3 class="mat-h3">{{ selStyleWid ? selStyleWid.widgetTitle : 'Untitled' }} Properties</h3>
                      <span class="f-spacer"></span>
                      <button mat-icon-button (click)="showProperty=false">
                        <mat-icon>clear</mat-icon>
                    </button>
                    </mat-toolbar-row>
                </mat-toolbar>
                <mat-card-content>
                    <!-- BASIC CONFIGURATION-->
                    <mat-accordion>
                        <mat-expansion-panel class="mat-elevation-z2" expanded="true">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                Basic Configuration
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="f-col" [formGroup] = "styleCtrlGrp">
                                <mat-label>Widget Name</mat-label>
                                <mat-form-field appearance="outline">
                                    <input matInput formControlName="widgetName">
                                </mat-form-field>

                                <div class="f-row">
                                    <div class = "f-col">
                                    <mat-label>Width</mat-label>
                                </div>
                                    <mat-form-field class="field-divider" appearance="outline">
                                        <input type="number" max="pixcel" min="0" matInput formControlName="width">
                                    </mat-form-field>
                                    <span class="f-col-spacer-half"></span>
                                    <mat-label>Height</mat-label>
                                    <mat-form-field class="field-divider" appearance="outline">
                                        <input type="number" min="200" matInput formControlName="height">
                                    </mat-form-field>
                                </div>

                                <mat-label>Data Set</mat-label>
                                <mat-form-field appearance="outline">
                                    <mat-select formControlName="objectType">
                                        <mat-option *ngFor="let object of dataSetOb | async" value="{{ object.objectid }}"> {{ object.objectdesc }} </mat-option>
                                    </mat-select>
                                    <mat-hint *ngIf="selStyleWid  && selStyleWid.objectType && recordsCount">Total {{ recordsCount }} record(s) found</mat-hint>
                                    <mat-hint *ngIf="selStyleWid  && selStyleWid.objectType && !recordsCount">Index not found , please sync data</mat-hint>                                    
                                </mat-form-field>

                                <!-- FOR Aggregration -->
                                <ng-template [ngIf]="selStyleWid  && (selStyleWid.widgetType === 'COUNT' || selStyleWid.widgetType === 'BAR_CHART' || selStyleWid.widgetType === 'STACKED_BAR_CHART') ">
                                    <mat-label>Aggregration Operator</mat-label>
                                    <mat-form-field appearance="outline">
                                        <mat-select formControlName="aggregrationOp">
                                            <mat-option value="GROUPBY">GROUPBY</mat-option>
                                            <mat-option value="COUNT">COUNT</mat-option>
                                            <mat-option value="MIN">MIN</mat-option>
                                            <mat-option value="MAX">MAX</mat-option>
                                            <mat-option value="SUM">SUM</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </ng-template>

                                <ng-template [ngIf]="selStyleWid && (selStyleWid.widgetType === 'COUNT' || selStyleWid.widgetType === 'BAR_CHART' || selStyleWid.widgetType === 'STACKED_BAR_CHART' || selStyleWid.widgetType === 'FILTER')">
                                    <pros-metadatafield-control
                                    [moduleId] = "selStyleWid && selStyleWid.objectType"
                                    lebel = "Field"
                                    [selectedFldId] = "selStyleWid && selStyleWid.field"
                                    (selectionChange) = 'onFieldChange($event)'
                                    >
                                    </pros-metadatafield-control>
                                </ng-template>

                                <!-- FOR STACKED BAR CHART WIDGET-->
                                <ng-template [ngIf]="selStyleWid && selStyleWid.widgetType === 'STACKED_BAR_CHART'">
                                    <pros-metadatafield-control
                                        [moduleId] = "selStyleWid && selStyleWid.objectType"
                                        lebel = "Group With(s)"
                                        [selectedFldId] = "selStyleWid && selStyleWid.groupById"
                                        (selectionChange) = 'onGroupByChange($event)'>
                                    </pros-metadatafield-control>
                                </ng-template>

                                <!-- FOR FILTERs WIDGET-->
                                <ng-template [ngIf]="selStyleWid && selStyleWid.widgetType === 'FILTER' ">

                                    <!-- if date type field then , special config -->
                                    <ng-template 
                                    [ngIf]="selStyleWid.fieldCtrl && selStyleWid.fieldCtrl.picklist === '0' && (selStyleWid.fieldCtrl.dataType === 'DTMS' || selStyleWid.fieldCtrl.dataType === 'DATS')"
                                    [ngIfElse]="otherCtrl">
                                         
                                        <mat-form-field appearance="outline">
                                            <mat-label>Select date</mat-label>
                                            <mat-select formControlName="dateSelectionType">
                                                <mat-option>
                                                    No Date 
                                                </mat-option>
                                                <mat-option value="TODAY">
                                                    Today 
                                                </mat-option>
                                                <mat-option value="DAY_7">
                                                    7 Days
                                                </mat-option>
                                                <mat-option value="DAY_10">
                                                    10 Days
                                                </mat-option>
                                                <mat-option value="DAY_20">
                                                    20 Days
                                                </mat-option>
                                                <mat-option value="DAY_30">
                                                    30 Days
                                                </mat-option>
                                                <mat-option value="CUSTOM">Custom Date</mat-option>
                                            </mat-select>
                                        </mat-form-field>

                                        <!-- when user choose custom date then start and end date should appear -->
                                        <ng-template [ngIf]="styleCtrlGrp && styleCtrlGrp.get('dateSelectionType').value === 'CUSTOM'">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Choose start date</mat-label>
                                                <input matInput matInput [matDatepicker]="startDate" disabled formControlName="startDate">
                                                <mat-datepicker-toggle matSuffix [for]="startDate"></mat-datepicker-toggle>
                                                <mat-datepicker #startDate disabled="false"></mat-datepicker>
                                            </mat-form-field>
    
                                            <mat-form-field appearance="outline">
                                                <mat-label>Choose end date</mat-label>
                                                <input matInput matInput [matDatepicker]="endDate" disabled formControlName="endDate">
                                                <mat-datepicker-toggle matSuffix [for]="endDate"></mat-datepicker-toggle>
                                                <mat-datepicker #endDate disabled="false"></mat-datepicker>
                                            </mat-form-field>
                                        </ng-template>
                                    </ng-template>
                                    <ng-template #otherCtrl>
                                        <mat-form-field appearance="outline">
                                            <mat-label>Filter Type</mat-label>
                                            <mat-select formControlName="filterType">
                                                <mat-option value="DROPDOWN_VALS">Dropdown value</mat-option>
                                                <mat-option value="HORIZONTAL_VALS">Horizontal value</mat-option>
                                                <mat-option value="VERTICAL_VALS">Vertical value</mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-checkbox color="primary" formControlName="isMultiSelect">Is Multiselect</mat-checkbox>
                                    </ng-template>
                                </ng-template>
                                
                                <!-- FOR TABLE LIST CHOOSE COLUMNS WIDGET-->
                                <ng-template [ngIf]="selStyleWid && selStyleWid.widgetType === 'TABLE_LIST'">
                                    <mat-label>{{ chooseColumns ? chooseColumns.length : '0' }} Selected</mat-label>
                                    <mat-form-field appearance="outline">
                                        <mat-select>
                                            <mat-option *ngFor="let field of headerFields | async" value="{{ field.fieldId }}" >
                                                <div (click)="optionClicked($event, field)">
                                                    <mat-checkbox prosClickStopPropagation (change)="toggleSelection(field)" [checked]="isSelected(field)" color="primary">
                                                    {{ field.fieldDescri }}
                                                    </mat-checkbox>
                                                </div>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </ng-template>

                                <!-- FOR IMAGE WIDGET-->
                                <ng-template [ngIf]="selStyleWid && selStyleWid.widgetType === 'IMAGE'">
                                    <mat-label>Image Link</mat-label>
                                    <mat-form-field appearance="outline">
                                        <input matInput formControlName="imageUrl">
                                    </mat-form-field>

                                    <div class="f-row">
                                    <button mat-icon-button matTooltip="Upload image" (click)="uploadFileChange()">
                                        <mat-icon color="primary">add_photo_alternate</mat-icon>
                                        </button>
                                        <input type="file" (change)="fileChange($event)" style="display: none;" multiple="false" id="uploadFileCtrl" accept="image/png, image/jpeg"/>
                                        <span class="f-col-spacer-half"></span>
                                        <mat-form-field class="upload-img-inp">
                                            <input matInput disabled readonly formControlName="imageName">
                                            <button mat-button matSuffix mat-icon-button aria-label="Clear" (click)="removeUploadedImage()">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </mat-form-field>
                                    </div>
                                </ng-template>

                                <!-- FOR IMAGE WIDGET-->
                                <ng-template [ngIf]="selStyleWid && selStyleWid.widgetType === 'HTML'">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Html content</mat-label>
                                        <textarea matInput placeholder="Write html text.." formControlName="htmlText"></textarea>
                                    </mat-form-field>
                                </ng-template>
                                
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                    <!-- CHART PROPERTIES -->
                    <mat-accordion *ngIf="selStyleWid  && (selStyleWid.widgetType === 'BAR_CHART' || selStyleWid.widgetType === 'STACKED_BAR_CHART') ">
                        <mat-expansion-panel class="mat-elevation-z2">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                Chart Properties
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="f-col" [formGroup] = "chartPropCtrlGrp">
                                <mat-form-field appearance="outline">
                                    <mat-label>Chart Type </mat-label>
                                    <mat-select formControlName="chartType">
                                        <mat-option value="BAR"> BAR </mat-option>
                                        <mat-option *ngIf="selStyleWid.widgetType === 'BAR_CHART' " value="PIE"> PIE </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" *ngIf="chartPropCtrlGrp && chartPropCtrlGrp.get('chartType').value === 'BAR'">
                                    <mat-label>Orientation</mat-label>
                                    <mat-select formControlName="orientation">
                                        <mat-option value="VERTICAL"> Vertical </mat-option>
                                        <mat-option value="HORIZONTAL"> Horizontal </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <ng-template [ngIf]="chartPropCtrlGrp && chartPropCtrlGrp.get('chartType').value === 'BAR'">
                                    <mat-label>xAsix Lebel</mat-label>
                                    <mat-form-field appearance="outline">
                                        <input matInput formControlName="xAxisLabel">
                                    </mat-form-field>

                                    <mat-label>yAsix Lebel</mat-label>
                                    <mat-form-field appearance="outline">
                                        <input matInput formControlName="yAxisLabel">
                                    </mat-form-field>

                                    <mat-label>Count OrderBy </mat-label>
                                    <mat-form-field appearance="outline">
                                        <mat-select formControlName="orderWith">
                                            <mat-option value="asc"> Ascending </mat-option>
                                            <mat-option value="desc"> Descending  </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <div class="f-row">
                                        <mat-label>Scale From</mat-label>
                                        <mat-form-field class="field-divider" appearance="outline">
                                            <input type="number" min="0" matInput formControlName="scaleFrom">
                                        </mat-form-field>
                                        <span class="f-col-spacer-half"></span>
                                        <mat-label>Scale To</mat-label>
                                        <mat-form-field class="field-divider" appearance="outline">
                                            <input type="number" min="0" matInput formControlName="scaleTo">
                                        </mat-form-field>
                                    </div>

                                    <div class="f-row">
                                        <mat-label>Scale Step Size</mat-label>
                                        <mat-form-field class="field-divider" appearance="outline">
                                            <input type="number" min="0" matInput formControlName="stepSize">
                                        </mat-form-field>
                                        <span class="f-col-spacer-half"></span>
                                        <mat-label>Max dataset number</mat-label>
                                        <mat-form-field class="field-divider" appearance="outline">
                                            <input type="number" min="0" matInput formControlName="dataSetSize">
                                        </mat-form-field>
                                    </div>
                                </ng-template>


                                <mat-checkbox color="primary" formControlName="isEnableDatalabels">Enable Datalabels</mat-checkbox>

                                <mat-label>Datalabels Position</mat-label>
                                <mat-form-field appearance="outline" *ngIf="chartPropCtrlGrp && chartPropCtrlGrp.get('isEnableDatalabels').value && chartPropCtrlGrp.get('chartType').value !== 'PIE'">
                                    <mat-select formControlName="datalabelsPosition">
                                        <mat-option value="center"> Center </mat-option>
                                        <mat-option value="start"> Start </mat-option>
                                        <mat-option value="end"> End </mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-checkbox color="primary" formControlName="isEnableLegend">Show Legend</mat-checkbox>
                                
                                <mat-label>Legend Position</mat-label>
                                <mat-form-field appearance="outline" *ngIf="chartPropCtrlGrp && chartPropCtrlGrp.get('isEnableLegend').value">
                                    <mat-select formControlName="legendPosition">
                                        <mat-option value="top"> Top </mat-option>
                                        <mat-option value="left"> Left </mat-option>
                                        <mat-option value="bottom"> Bottom </mat-option>
                                        <mat-option value="right"> Right </mat-option>
                                    </mat-select>
                                </mat-form-field>
                                
                                <mat-form-field appearance="outline">
                                    <mat-label>Default value alias</mat-label>
                                    <input matInput formControlName="blankValueAlias">
                                </mat-form-field>
                                
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                    <!-- DEFAULT FILTERS -->
                    <mat-accordion>
                        <mat-expansion-panel class="mat-elevation-z2">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                Default Filters
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <ng-template [ngIf]="selStyleWid  && selStyleWid.defaultFilters">
                                <div class="f-col" [formGroup] = "defaultFilterCtrlGrp">                                
                                    <div class="f-row" formArrayName="filters" *ngFor="let filter of defaultFilterCtrlGrp.get('filters').controls; let i = index">
                                        <ng-container [formGroupName]="i">                                            
                                            <pros-metadatafield-control
                                                [moduleId] = "selStyleWid && selStyleWid.objectType"
                                                lebel = "Field "
                                                [selectedFldId] = "selStyleWid && selStyleWid.defaultFilters && (selStyleWid.defaultFilters[i]).conditionFieldId"
                                                (selectionChange) = 'onDefaultFilterChange($event,i)' class="field-divider">
                                            </pros-metadatafield-control>

                                            <span class="f-col-spacer"></span>
                                            <mat-form-field appearance="outline" class="field-divider">
                                                <mat-label>Value</mat-label>
                                                <input matInput formControlName="conditionFieldValue">
                                            </mat-form-field>
                                            <span class="f-col-spacer-half"></span>
                                            <button mat-button mat-icon-button (click)="removeFilter(i)" matTooltip="Remove" color="warn">
                                                <mat-icon>remove_circle_outline</mat-icon> 
                                            </button>
                                            
                                        </ng-container>
                                    </div>
                                </div>
                            </ng-template>
                            <span class="row-spacer"></span>
                            <div class="f-row add-button">
                                <button mat-button (click)="addMoreDefaultFilter()" color="primary">
                                    Add 
                                </button>
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>


                </mat-card-content>
            </mat-card>
        </div>
    </mat-card>
    
</div>






