<div class="root">
  <div class="f-row breadcrum-toolbar">
    <button mat-button (click)="closeDialogComponent()">
      <mat-icon fontSet="mdo-icons">close</mat-icon>
    </button>
    <div class="col-spacer"></div>
    <div class="f-col mdo-constrained-right">
      <div class="f-row breadcrum-head">
        <div class="display-heading-large">Business rule</div>
        <span class="f-spacer"></span>
        <button mat-flat-button color="primary" (click)="save();$event.stopPropagation()">Save</button>
      </div>
    </div>
  </div>

  <div class="f-col sidesheetcontent-listing">
    <div class="f-col mdo-justify">
      <form [formGroup]="form">
        <div class="f-col mdo-form-field">
          <mat-label>Rule type</mat-label>
          <mat-form-field appearance="outline">
            <mat-select formControlName="rule_type">
              <ng-container *ngFor="let rule of businessRuleTypes">
                <mat-option *ngIf="rule.isImplemented" [value]="rule.ruleType">{{rule.ruleDesc}}
                </mat-option>
              </ng-container>
            </mat-select>
            <mat-error *ngIf="submitted && form.controls.rule_type.errors && form.controls.rule_type.errors.required">
              Please enter rule type</mat-error>
          </mat-form-field>
        </div>

        <div class="f-col mdo-form-field" *ngIf="!isDuplicateType">
          <mat-label>Weightage</mat-label>
          <mat-slider thumbLabel formControlName="weightage" [displayWith]="formatLabel" tickInterval="1" min="0"
            [max]="maxWeightageLimit" color="primary"></mat-slider>
          <mat-error *ngIf="submitted && form.controls.weightage.errors && form.controls.weightage.errors.required">
            Please enter weightage</mat-error>
        </div>

        <div class="f-col mdo-form-field" *ngIf="!isUDR && !isDuplicateType">
          <mat-label>Category</mat-label>
          <mat-form-field appearance="outline">
            <mat-select formControlName="categoryId">
              <ng-container *ngFor="let category of categoryList">
                <mat-option [value]="category.categoryId">{{category.categoryDesc}}
                </mat-option>
              </ng-container>
            </mat-select>
          </mat-form-field>

          <mat-error *ngIf="submitted && form.controls.categoryId.errors && form.controls.categoryId.errors.required">
            Please enter category id</mat-error>
        </div>

        <div class="f-col mdo-form-field">
          <pros-form-input [value]="form.get('rule_name').value" (valueChange)="getFormValue($event,'rule_name')"
            [label]="'Rule name (Description)'">
          </pros-form-input>
          <mat-error *ngIf="submitted && form.controls.rule_name.errors && form.controls.rule_name.errors.required">
            Please enter rule name</mat-error>
        </div>

        <div class="f-col mdo-form-field" *ngIf="!isDuplicateType">
          <pros-form-input [value]="form.get('error_message').value"
            (valueChange)="getFormValue($event,'error_message')" [label]="'Error message (Message)'">
          </pros-form-input>
          <mat-error
            *ngIf="submitted && form.controls.error_message.errors && form.controls.error_message.errors.required">
            Please enter error message</mat-error>
        </div>

        <div class="f-col mdo-form-field" *ngIf="form.controls.rule_type.value === 'BR_CLASSIFICATION'">
          <pros-form-input [value]="form.get('apiKey').value" (valueChange)="getFormValue($event,'apiKey')"
            [label]="'Enter access token'">
          </pros-form-input>
          <mat-error *ngIf="submitted && form.controls.apiKey.errors && form.controls.apiKey.errors.required">
            Please enter access token</mat-error>
        </div>

        <mat-divider class="dashed-divider"></mat-divider>

        <div class="f-row mdo-form-field" *ngIf="isTransformationRule">
          <mat-radio-group formControlName="transformationRuleType" class="f-row">
            <mat-radio-button [value]="transformationType.REGEX" color="primary">{{transformationType.REGEX}}
            </mat-radio-button>
            <span class="col-spacer"></span>
            <mat-radio-button [value]="transformationType.LOOKUP" color="primary">{{transformationType.LOOKUP}}
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- transformation rule -->
        <pros-transformation-rule
          *ngIf="isTransformationRule && selectedTransformationType === transformationType.REGEX"
          [selectedRuleType]="currentSelectedRule" [targetFieldsObject]="targetFieldsObject"
          [sourceFieldsObject]="sourceFieldsObject" [submitted]="submitted"
          [initialTransformationData]="transformationData"
          (transformationFormOutput)="setTransformationFormData($event)">
        </pros-transformation-rule>

        <!-- transformation lookup rule -->
        <pros-lookup-rule *ngIf="isTransformationRule && selectedTransformationType === transformationType.LOOKUP"
          [fieldsObject]="sourceFieldsObject" [initialLookupData]="transformationLookUpData"
          (lookupRuleOutput)="setLookupData($event)">
        </pros-lookup-rule>

        <!-- Duplicate Rule form group  -->
        <pros-setup-duplicate-rule *ngIf="isDuplicateType" [coreSchemaBrInfo]="duplicacyRuleData"
          [fieldsList]="fieldsList" [submitted]="submitted" (formChange)="setDuplicateFormRef($event)">
        </pros-setup-duplicate-rule>

        <div class="f-col mdo-form-field" *ngIf="!isUDR && !isTransformationRule && !isDuplicateType">
          <mat-label>Fields</mat-label>
          <mat-form-field appearance="outline">
            <mat-chip-list #chipList>
              <mat-chip *ngFor="let field of selectedFields;let i = index" [removable]="true"
                (removed)="remove(field,i)">
                {{field.fieldDescri}}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip>
              <input matInput id="fieldsInput" #fieldsInput class="mat-input" [matAutocomplete]="auto" formControlName="fields"
                [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes">
            </mat-chip-list>
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn.bind(this)"
              (optionSelected)="selectedField($event)">
              <mat-option *ngFor="let fieldItem of filteredModules | async" [value]="fieldItem.fieldId">
                {{fieldItem.fieldDescri}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
          <mat-error *ngIf="submitted && form.controls.fields.errors && form.controls.fields.errors.required">
            Please select the fields
          </mat-error>
        </div>

        <div class="f-col mdo-form-field" *ngIf="isRegexType">
          <mat-label>Standard function</mat-label>
          <mat-form-field appearance="outline">
            <mat-select formControlName='standard_function' (selectionChange)='setRegex($event)'>
              <mat-option *ngFor="let regex of preDefinedRegex" [value]="regex.FUNC_TYPE">
                {{regex.FUNC_NAME}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-error
            *ngIf="submitted && form.controls.standard_function.errors && form.controls.standard_function.errors.required">
            Please select the standard function</mat-error>
        </div>

        <div class="f-col mdo-form-field" *ngIf="isRegexType">
          <pros-form-input [value]='form.value.regex' (valueChange)="getFormValue($event,'regex')"
            [label]="'Regex value'">
          </pros-form-input>
          <mat-error *ngIf="submitted && form.controls.regex.errors && form.controls.regex.errors.required">
            Please enter regex</mat-error>
        </div>
      </form>
      <div class="f-col user-defined-set" *ngIf="isUDR">
        <ng-container *ngFor="let udrBlock of udrBlocks;let i = index">
          <div class="f-row defined-row" [id]="udrBlock.id">
            <!-- rule type -->
            <div class="col select-col" *ngIf="i > 0">
              <mat-select mat-stroked-button [(ngModel)]="udrBlock.blockTypeText"
                (selectionChange)="setParentBlockTypeText($event,i)">
                <mat-option *ngFor="let condition of initialConditions" [value]="condition">
                  {{condition}}
                </mat-option>
              </mat-select>
            </div>

            <div class="col" *ngIf="i === 0">
              <button mat-flat-button color="accent">When</button>
            </div>

            <!-- field name -->
            <div class="col">
              <mat-select [(ngModel)]="udrBlock.fieldId" placeholder="Select Field">
                <mat-option *ngFor="let fieldItem of fieldsList" [value]="fieldItem.fieldId">
                  {{fieldItem.fieldDescri}}
                </mat-option>
              </mat-select>
            </div>

            <!-- operators -->
            <div class="col">
              <!-- <button mat-stroked-button>Equals <mat-icon>arrow_drop_down</mat-icon></button> -->
              <mat-select mat-stroked-button [(ngModel)]="udrBlock.operator" placeholder="Select Operator">
                <mat-option selected>-- None --</mat-option>
                <mat-optgroup *ngFor="let group of operators" [label]="group.desc">
                  <mat-option *ngFor="let child of group.childs" [value]="child">
                    <ng-container *ngIf="child !== 'EQUAL' && child !== 'FIELD2FIELD'">
                      {{child | replaceUnderscorePipe}}
                      </ng-container>
                      <ng-container *ngIf="child === 'EQUAL'">
                      {{'EQUALS'}}
                      </ng-container>
                      <ng-container *ngIf="child === 'FIELD2FIELD'">
                      {{'FIELD TO FIELD'}}
                      </ng-container>
                  </mat-option>
                </mat-optgroup>
              </mat-select>
            </div>

            <!-- Comparison value -->
            <div class="col" *ngIf="udrBlock.operator !== 'RANGE'">
              <pros-form-input [placeholder]="'Comparison value'" (valueChange)="setComparisonValue($event,i)"
                [value]="udrBlock.comparisonValue">
              </pros-form-input>
            </div>

            <div class="col" *ngIf="udrBlock.operator === 'RANGE'">
              <div class="f-row">
                <pros-form-input [placeholder]="'start value'" (valueChange)="setRangeValue($event,'start',i)">
                </pros-form-input>
                <div class="f-col-spacer-half"></div>
                <pros-form-input [placeholder]="'end value'" (valueChange)="setRangeValue($event,'end',i)">
                </pros-form-input>
              </div>
            </div>

            <!-- three dots -->
            <div class="col">
              <button mat-button [matMenuTriggerFor]="menu">
                <mat-icon fontSet="mdo-icons">list-item-drag</mat-icon>
              </button>
            </div>

            <mat-menu #menu="matMenu" class="navigation-menu">
              <!-- give local reference and tell this is manu by assigning 'matMenu' -->
              <button mat-menu-item (click)="addBlock(true,udrBlock,i)">
                Add child rule
              </button>

              <button mat-menu-item *ngIf="i > 0" (click)="deleteParentBlock(i,udrBlock)">
                Delete
              </button>
            </mat-menu>
          </div>

          <!-- nested row -->

          <ng-container *ngIf="udrBlock.children">
            <div *ngFor="let child of udrBlock.children;let j=index">
              <ul class="sub-defined">
                <div class="f-row defined-row">

                  <div class="col select-col">
                    <mat-select [(ngModel)]="child.blockTypeText">
                      <mat-option *ngFor="let condition of initialConditions" [value]="condition"
                        [disabled]="condition === 'When'">
                        {{condition}}
                      </mat-option>
                    </mat-select>
                  </div>

                  <div class="col">
                    <mat-select [(ngModel)]="child.fieldId" placeholder="Select Field">
                      <mat-option *ngFor="let fieldItem of fieldsList" [value]="fieldItem.fieldId">
                        {{fieldItem.fieldDescri}}
                      </mat-option>
                    </mat-select>
                  </div>

                  <div class="col">
                    <mat-select mat-stroked-button [(ngModel)]="child.operator" placeholder="Select Operator">
                      <mat-option selected>-- None --</mat-option>
                      <mat-optgroup *ngFor="let group of operators" [label]="group.desc">
                        <mat-option *ngFor="let child of group.childs" [value]="child">
                          <ng-container *ngIf="child !== 'EQUAL' && child !== 'FIELD2FIELD'">
                            {{child | replaceUnderscorePipe}}
                            </ng-container>
                            <ng-container *ngIf="child === 'EQUAL'">
                            {{'EQUALS'}}
                            </ng-container>
                            <ng-container *ngIf="child === 'FIELD2FIELD'">
                            {{'FIELD TO FIELD'}}
                            </ng-container>
                        </mat-option>
                      </mat-optgroup>
                    </mat-select>
                  </div>

                  <div class="col" *ngIf="child.operator !== 'RANGE'">
                    <pros-form-input [placeholder]="'Comparison value'" [value]="child.comparisonValue"
                      (valueChange)="setComparisonValueForChild($event,child,i)">
                    </pros-form-input>
                  </div>

                  <div class="col" *ngIf="child.operator === 'RANGE'">
                    <pros-form-input [placeholder]="'start value'" [value]="child.rangeStartValue"
                      (valueChange)="setRangeValueForChild($event,'start',child)">
                    </pros-form-input>
                    <pros-form-input [placeholder]="'end value'" [value]="child.rangeEndValue"
                      (valueChange)="setRangeValueForChild($event,'end',child)">
                    </pros-form-input>
                  </div>

                  <div class="col">
                    <button mat-button [matMenuTriggerFor]="nestedMenu">
                      <mat-icon fontSet="mdo-icons">list-item-drag</mat-icon>
                    </button>
                    <mat-menu #nestedMenu="matMenu" class="navigation-menu">
                      <!-- give local reference and tell this is manu by assigning 'matMenu' -->
                      <!-- <button mat-menu-item (click)="addNestedBlock(udrBlock,i)">
                                                <mat-icon>add</mat-icon>
                                                <span>Add</span>
                                            </button> -->

                      <button mat-menu-item (click)="deleteFromChildArray(i,j,child)">
                        Delete
                      </button>
                    </mat-menu>
                  </div>
                </div>
              </ul>
            </div>
          </ng-container>
        </ng-container>
        <!-- button to ad primary block -->
        <div class="f-row defined-row add-col">
          <div class="col">
            <button mat-flat-button color="accent" (click)="addBlock(false,null,0)">
              <mat-icon fontSet="mdo-icons">plus</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>