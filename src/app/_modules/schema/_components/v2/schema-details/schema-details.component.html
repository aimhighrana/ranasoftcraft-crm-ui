<div class="mat-elevation-z0 root">
    <div class="f-row breadcrum-toolbar">
        <div class="display-heading-large">
            <ng-template [ngIf]="schemaInfo">
                {{ schemaInfo.moduleDescription ? schemaInfo.moduleDescription : 'Module' }} /
                {{ schemaInfo.schemaDescription ? schemaInfo.schemaDescription : 'Untitled'}} / {{variantName}}
                <button mat-button [matMenuTriggerFor]="menu">
                    <mat-icon fontSet="mdo-icons">menu-arrow</mat-icon>
                </button>
                <mat-menu #menu="matMenu" class="navigation-menu">
                    <button mat-menu-item (click)="openDataScopeSideSheet()">[New data scope]</button>
                    <button mat-menu-item (click)="variantChange('0')">Entire dataset</button>
                    <ng-container *ngIf="dataScope && dataScope.length">
                        <button mat-menu-item *ngFor="let scope of dataScope" (click)="variantChange(scope.variantId)">
                            {{ scope.variantName ? scope.variantName : 'Unknown'}}
                        </button>
                    </ng-container>
                </mat-menu>
            </ng-template>
        </div>
        <div class="f-spacer"></div>
        <div class="f-row action-iconbtns">
            <button mat-flat-button color="accent" (click)="openSummarySideSheet()">
                <mat-icon fontSet="mdo-icons">wand</mat-icon> Check data
            </button>
            <button mat-fab color="accent" (click)="openExecutionTrendSideSheet()">
                <mat-icon fontSet="mdo-icons">chart-line</mat-icon>
            </button>
            <button mat-fab *ngIf="activeTab !== 'error'" color="accent" [matMenuTriggerFor]="moreactionfile">
                <mat-icon fontSet="mdo-icons">more</mat-icon>
            </button>
            <mat-menu #moreactionfile="matMenu" class="navigation-menu">
                <button mat-menu-item (click)="downloadExecutionDetails()">Export to CSV</button>
            </mat-menu>
            <!-- <button mat-flat-button color="accent" (click)="downloadExecutionDetails()">Download</button> -->
        </div>
    </div>
    <ng-template [ngIf]="isInRunning" [ngIfElse]="schemaInfoTemplate">
        <pros-schema-progress [schemaId]="schemaId"></pros-schema-progress>
    </ng-template>

    <ng-template #schemaInfoTemplate>
    <mat-divider></mat-divider>
    <div class="row-spacer"></div>
    <div class="f-row">
        <mat-chip-list>
            <mat-chip disableRipple="true" class="error-status" (click)="changeTabStatus('error')">
                {{ (statics && statics.errorCnt) ? statics.errorCnt : 0 }} errors
            </mat-chip>
            <mat-chip disableRipple="true" class="success-status" (click)="changeTabStatus('success')">
                {{ (statics && statics.successCnt) ? statics.successCnt : 0 }} success
            </mat-chip>
            <mat-chip disableRipple="true" class="info-status" (click)="changeTabStatus('review')">
                {{ (statics && statics.correctedCnt) ? statics.correctedCnt : 0 }} corrections
            </mat-chip>
        </mat-chip-list>
    </div>
    <div class="row-spacer"></div>
    <mat-divider></mat-divider>
    <!-- <nav mat-tab-nav-bar>
        <a mat-tab-link [active]="activeTab === 'error'" (click)="changeTabStatus('error')">
            Error
            <mat-chip-list class="mdo-tabchiplist">
                <mat-chip>{{ (statics && statics.errorCnt) ? statics.errorCnt : 0 }}</mat-chip>
            </mat-chip-list>
        </a>
        <a mat-tab-link [active]="activeTab === 'success'" (click)="changeTabStatus('success')">
            Success
            <mat-chip-list class="mdo-tabchiplist">
                <mat-chip>{{ (statics && statics.successCnt) ? statics.successCnt : 0 }}</mat-chip>
            </mat-chip-list>
        </a>
        <a mat-tab-link [active]="activeTab === 'review'" (click)="changeTabStatus('review')">
            Ready for review
            <mat-chip-list class="mdo-tabchiplist">
                <mat-chip>{{ (statics && statics.correctedCnt) ? statics.correctedCnt : 0 }}</mat-chip>
            </mat-chip-list>
        </a>
    </nav> -->
    <div class="f-row filter-container">
        <!-- Filter here...-->
        <mat-chip-list>
            <pros-search-input placeholder="Search text" (value)="inlineSearchSubject.next($event);" [preValue]="preInpVal">
            </pros-search-input>
            <div class="f-col-spacer-half"></div>
            <ng-template ngFor let-ctrl [ngForOf]="filterCriteria | async">
                <ng-template [ngIf]="ctrl.type !== 'INLINE'">
                    <mat-chip class="mdo-filter-matchip" disableRipple="true" [matMenuTriggerFor]="appliedfiltermenu"
                        (click)="loadDropValues(ctrl)">
                        <label>
                            {{ ctrl.filterCtrl ? ctrl.filterCtrl.fldCtrl.fieldDescri : 'Unknown' }} :
                        </label>
                        <ng-template [ngIf]="ctrl.filterCtrl.selectedValues.length > 1" [ngIfElse]="showText">
                            <span class="info">
                                {{ prepareTextToShow(ctrl) }}
                            </span>
                        </ng-template>
                        <ng-template #showText>
                            <span class="info">
                                <!-- {{ ctrl.filterCtrl ? (ctrl.filterCtrl.selectedValeus[0].TEXT ? ctrl.filterCtrl.selectedValeus[0].TEXT : ctrl.filterCtrl.selectedValeus[0].CODE) : ''}} -->
                                {{ prepareTextToShow(ctrl)}}
                            </span>
                        </ng-template>
                        <mat-icon matChipRemove (click)="removeAppliedFilter(ctrl)">clear</mat-icon>
                    </mat-chip>
                     <!-- Append dynamic filter MatMenu -->
                    <mat-menu #appliedfiltermenu="matMenu">
                        <pros-filter-values [fieldId]="loadDopValuesFor ? loadDopValuesFor.fieldId : ''"
                            [checkedValue]="loadDopValuesFor ? loadDopValuesFor.checkedValue : []"
                            (selectedValues)="updateFilterCriteria($event)"></pros-filter-values>
                    </mat-menu>
                </ng-template>
            </ng-template>
           
            <!-- Add filter control -->
            <mat-chip class="mdo-filter-matchip" disableRipple="true" [matMenuTriggerFor]="addfiltermenu"
                (click)="reInilize = !reInilize">
                <mat-icon fontSet="mdo-icons">folder-filter</mat-icon>
            </mat-chip>
            <!-- Add filter control MatMenu -->
            <mat-menu #addfiltermenu="matMenu">
                <pros-add-filter-menu [moduleId]="moduleId" (evtReadyForApply)="makeFilterControl($event)"
                    [reInilize]="reInilize">
                </pros-add-filter-menu>
            </mat-menu>
            <!-- More control -->
            <mat-chip class="mdo-filter-matchip" disableRipple="true" [matMenuTriggerFor]="moreFilterMenu">
                <mat-icon fontSet="mdo-icons">more</mat-icon>
            </mat-chip>
            <!-- More control MatMenu -->
            <mat-menu #moreFilterMenu="matMenu" class="navigation-menu">
                <button mat-menu-item (click)="opnDialogSaveVariant()">Save as...</button>
                <button mat-menu-item (click)="resetAppliedFilter()">Reset</button>
            </mat-menu>
        </mat-chip-list>
    </div>
    <div class="f-row action-iconbtns" *ngIf="activeTab && activeTab === 'review' && selection.selected.length !== 0">
        <ng-template [ngIf]="(isReviewer || isApprover) && isGlobalActionsEnabled">
            <button mat-flat-button (click)="approveRecords('all')" color="accent">
                Approve
            </button>
            <button mat-flat-button (click)="resetRec('','all')" color="accent">
                Reject
            </button>
        </ng-template>
        <button mat-flat-button (click)="selection.clear()" color="accent">
            Unselect
        </button>
    </div>
    <div class="data" (scroll)="onTableScroll($event)">
        <!-- if have data then render table -->
        <ng-template [ngIf]="showTableLoading" [ngIfElse]="showdata">
            <pros-table-loading [columnCount]="displayedFields.length">
            </pros-table-loading>
        </ng-template>
        <ng-template #showdata>
            <mat-table [dataSource]="dataSource" matSort class="mat-elevation-z0">
                <ng-container matColumnDef="_select_columns" sticky>
                    <mat-header-cell *matHeaderCellDef class="fixed-width-c1">
                        <mat-checkbox color="primary" (change)="$event ? masterToggle() : null"
                            [checked]="selection.hasValue() && isAllSelected()"
                            [indeterminate]="selection.hasValue() && !isAllSelected()">
                        </mat-checkbox>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let row" class="fixed-width-c1">
                        <mat-checkbox color="primary" (click)="$event.stopPropagation()"
                            (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)">
                        </mat-checkbox>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="row_more_action" sticky>
                    <mat-header-cell *matHeaderCellDef class="fixed-width-c1">
                        <button mat-button (click)="openTableColumnSettings()">
                            <mat-icon fontSet="mdo-icons">cog</mat-icon>
                        </button>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element" class="fixed-width-c1">
                        <button mat-button>
                            <mat-icon fontSet="mdo-icons">more</mat-icon>
                        </button>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="_assigned_buckets" sticky>
                    <mat-header-cell *matHeaderCellDef class="fixed-width-c1"></mat-header-cell>
                    <mat-cell *matCellDef="let element" class="fixed-width-c1">
                        <mat-card-header>
                            <div mat-card-avatar>
                                {{ userDetails ? (userDetails.firstName ?
                                userDetails.firstName.substring(0,1).toUpperCase() : '') : '' }}{{ userDetails ? (
                                userDetails.lastName ? userDetails.lastName.substring(0,1).toUpperCase() : '') : '' }}
                            </div>
                        </mat-card-header>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="_score_weightage" sticky>
                    <mat-header-cell *matHeaderCellDef class="fixed-width-c2"> Score &nbsp;<mat-icon
                            fontSet="mdo-icons">
                            question-mark</mat-icon>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element" class="fixed-width-c2">
                        <div class="f-row progress-cell">
                            <mat-progress-bar mode="determinate"
                                value="{{ element['_score_weightage'] ? element['_score_weightage'].fieldData : '0' }} "
                                class="f-col"></mat-progress-bar>
                            <span class="f-col-spacer-half"></span>
                            <span class="f-col">
                                {{ element['_score_weightage'] ? element['_score_weightage'].fieldData : '' }}%
                            </span>
                        </div>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="_row_actions" sticky>
                    <mat-header-cell *matHeaderCellDef>
                        Actions
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element">
                        <div class="f-row action-iconbtns" *ngIf="!element['OBJECTNUMBER'].isReviewed">
                            <!-- Secondary actions -->
                            <ng-template [ngIf]="true"> <!-- !isReviewer -->
                            <button mat-fab color="accent"
                                *ngIf="secondaryActions.length" [matMenuTriggerFor]="secondaryActionsMenu">
                                <mat-icon fontSet="mdo-icons">more</mat-icon>
                            </button>
                            <mat-menu #secondaryActionsMenu="matMenu" class="navigation-menu">
                                <button mat-menu-item *ngFor="let sAction of secondaryActions"
                                    (click)="doAction(sAction, element)">
                                    <mat-icon
                                        *ngIf="!sAction.isCustomAction && (sAction.actionViewType=== TableActionViewType.ICON || sAction.actionViewType=== TableActionViewType.ICON_TEXT)"
                                        fontSet="mdo-icons" class="mat-menu-icon">
                                        {{ getActionIcon(sAction.actionText) }}
                                    </mat-icon>
                                    <ng-template
                                        [ngIf]="(sAction.actionViewType === TableActionViewType.TEXT) || (sAction.actionViewType === TableActionViewType.ICON_TEXT)">
                                        {{ sAction.actionText }}
                                    </ng-template>
                                </button>
                            </mat-menu>
                            </ng-template>
                            <!-- Primary actions -->
                            <button *ngFor="let pAction of primaryActions" mat-flat-button color="accent"
                               (click)="doAction(pAction, element)">
                                <mat-icon
                                    *ngIf="(pAction.actionViewType=== TableActionViewType.ICON || pAction.actionViewType=== TableActionViewType.ICON_TEXT)"
                                    fontSet="mdo-icons">
                                    {{ getActionIcon(pAction.actionText) }}
                                </mat-icon>
                                <ng-template
                                    [ngIf]="pAction.actionViewType=== TableActionViewType.TEXT || pAction.actionViewType=== TableActionViewType.ICON_TEXT">
                                    {{ pAction.actionText }}
                                </ng-template>
                            </button>
                            <!-- <button mat-fab color="accent" prosClickStopPropagation (click)="approveRecords('inline', element)"
                                *ngIf="!element['OBJECTNUMBER'].isReviewed">
                                <mat-icon fontSet="mdo-icons">check-mark</mat-icon>
                            </button>
                            <button mat-fab color="accent" prosClickStopPropagation (click)="resetRec(element,'row')" *ngIf="!element['OBJECTNUMBER'].isReviewed">
                                <mat-icon fontSet="mdo-icons">declined</mat-icon>
                            </button> -->
                        </div>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="OBJECTNUMBER" sticky>
                    <mat-header-cell *matHeaderCellDef mat-sort-header> Object Number
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element">
                        {{ element['OBJECTNUMBER'] ? element['OBJECTNUMBER'].fieldData : '' }}
                    </mat-cell>
                </ng-container>
                <!-- load dynamic columns-->
                <ng-template ngFor let-dynCols [ngForOf]="(displayedFields | async)">
                    <ng-template
                        [ngIf]="(dynCols === 'row_more_action') || (dynCols === '_assigned_buckets') || (dynCols === '_row_actions') ||  ( dynCols === '_select_columns') ||   (dynCols === '_score_weightage') || (dynCols === 'OBJECTNUMBER')"
                        [ngIfElse]="other">
                        <!-- skip all static columns -->
                    </ng-template>
                    <ng-template #other>
                        <ng-container [matColumnDef]="dynCols">
                            <mat-header-cell *matHeaderCellDef mat-sort-header>
                                {{ metadataFldLst[dynCols] ? metadataFldLst[dynCols].fieldDescri : 'Unknown' }}
                            </mat-header-cell>
                            <mat-cell *matCellDef="let element; let rIndex = index;"
                                [class.error-cell]="element[dynCols] ? element[dynCols].isInError : false"
                                (click)="editCurrentCell(dynCols,element, rIndex, containerRef)">
                                <div class="f-col grid-cell-editable">
                                    <div class="mdo-form-input f-col" style="display: none;"
                                    id="inpctrl_{{ dynCols + '_' + rIndex }}">
                                    <!-- container to hold input field when cell gets edited  -->
                                    <ng-template prosContainerRef #containerRef="prosContainerRef">
                                    </ng-template>
                                </div>
                                <ng-template [ngIf]="element[dynCols] && element[dynCols].isCorrected"
                                    [ngIfElse]="normalCell">
                                    <ng-template [ngIf]="element[dynCols].oldData !== element[dynCols].fieldData"
                                        [ngIfElse]="other">
                                        <div class="f-col">
                                            <span id="viewctrl_{{ dynCols + '_' + rIndex }}">
                                                {{ element[dynCols] ? formatCellData(dynCols,
                                                element[dynCols].fieldData) : '' }}
                                            </span>
                                            <span>
                                                {{ element[dynCols] ? formatCellData(dynCols, element[dynCols].oldData) : '' }}
                                            </span>
                                        </div>
                                    </ng-template>
                                    <ng-template #other>
                                        <span id="viewctrl_{{ dynCols + '_' + rIndex }}">
                                            {{ element[dynCols] ? formatCellData(dynCols, element[dynCols].fieldData) :
                                            '' }}
                                        </span>
                                    </ng-template>
                                </ng-template>
                                <ng-template #normalCell>
                                    <div class="f-col">
                                        <span id="viewctrl_{{ dynCols + '_' + rIndex }}">
                                            {{ element[dynCols] ? formatCellData(dynCols, element[dynCols].fieldData) :
                                            '' }}
                                        </span>
                                        <span class="error-message">
                                            {{ element[dynCols] ? element[dynCols].errorMsg : '' }}
                                        </span>
                                    </div>
                                </ng-template>
                                </div>
                            </mat-cell>
                        </ng-container>
                    </ng-template>
                </ng-template>
                <!-- load header for actions-->
                <ng-container matColumnDef="review_actions_header">
                    <mat-header-cell *matHeaderCellDef [attr.colspan]="displayedFields.getValue().length">
                        <div class="f-row action-iconbtns">
                            <button mat-flat-button color="accent" (click)="approveRecords('all')">
                                <mat-icon fontSet="mdo-icons">check-mark</mat-icon>
                                Approve
                            </button>
                            <button mat-flat-button color="accent" (click)="selection.clear()">
                                <mat-icon fontSet="mdo-icons">close</mat-icon>
                                Unselect
                            </button>
                        </div>
                    </mat-header-cell>
                </ng-container>
                <!-- <mat-header-row *matHeaderRowDef="tableHeaderActBtn; sticky: true"></mat-header-row> -->
                <mat-header-row *matHeaderRowDef="displayedFields | async; sticky: true"></mat-header-row>
                <mat-row *matRowDef="let row; columns: displayedFields | async;"></mat-row>
            </mat-table>
        </ng-template>
    </div>
    </ng-template>
</div>