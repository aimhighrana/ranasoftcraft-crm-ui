<div class="mat-elevation-z0 root">
    <div class="f-row breadcrum-toolbar">
        <ng-template [ngIf]="schemaInfo">
            <div class="display-heading-large">
                {{ schemaInfo.moduleDescription ? schemaInfo.moduleDescription : 'Module' }} /
                {{ schemaInfo.schemaDescription ? schemaInfo.schemaDescription : 'Untitled'}} / {{variantName}}
            </div>
            <lib-button type="plain" iconFontType="solid" [matMenuTriggerFor]="menu" icon="caret-down"></lib-button>

            <mat-menu #menu="matMenu" class="navigation-menu">
                <button mat-menu-item (click)="openDataScopeSideSheet()">[New data scope] </button>
                <button mat-menu-item (click)="variantChange('0')"> Entire dataset </button>
                <ng-container *ngIf="dataScope && dataScope.length">
                    <button mat-menu-item *ngFor="let scope of dataScope" (click)="variantChange(scope.variantId)">
                        {{scope.variantName}}
                    </button>
                </ng-container>
            </mat-menu>
        </ng-template>
        <div class="f-col-spacer-half"></div>
        <div class="f-spacer"></div>
        <div class="f-row">
            <lib-button-group>
                <lib-button type="minor" iconPosition="before" icon="square-root-alt" (click)="openSummarySideSheet()">
                    Check data </lib-button>
                <lib-button type="minor" icon="chart-line" (click)="openExecutionTrendSideSheet()"></lib-button>
                <lib-button type="minor" [matMenuTriggerFor]="moreactionfile" icon="ellipsis-h"></lib-button>
            </lib-button-group>
            <mat-menu #moreactionfile="matMenu" class="navigation-menu">
                <button mat-menu-item (click)="downloadExecutionDetails()">Export to CSV</button>
                <!-- <button mat-menu-item>Import from CSV</button> -->
            </mat-menu>
        </div>
    </div>
    <ng-template [ngIf]="isInRunning" [ngIfElse]="schemaInfoTemplate">
        <pros-schema-progress [schemaId]="schemaId"></pros-schema-progress>
    </ng-template>

    <ng-template #schemaInfoTemplate>
        <mat-divider></mat-divider>
        <div class="row-spacer"></div>
        <div class="f-row">
            <mat-chip-list>
                <mat-chip (click)="changeTabStatus('error')" disableRipple="true" class="error-status">
                    {{ (statics && statics.errorCnt) ? statics.errorCnt : 0 }} errors
                </mat-chip>
                <mat-chip (click)="changeTabStatus('success')" disableRipple="true" class="warning-status">
                    {{ (statics && statics.successCnt) ? statics.successCnt : 0 }} warnings
                </mat-chip>
                <mat-chip (click)="changeTabStatus('review')" disableRipple="true" class="info-status">
                    {{ (statics && statics.correctedCnt) ? statics.correctedCnt : 0 }} corrections
                </mat-chip>
            </mat-chip-list>
        </div>
        <div class="f-row-spacer-half"></div>
        <div class="f-col data-container">
            <mat-tab-group disableRipple="true">
                <mat-tab>
                    <ng-template mat-tab-label>
                        Duplicate check
                    </ng-template>
                    <div class="f-row dataset-grid">
                        <div class="f-col dataset-grid-navigation group-table-container">
                            <!-- Group list table -->
                            <pros-group-data-table *ngIf="schemaInfo && schemaInfo.runId" [schemaId]="schemaId"
                                [variantId]="variantId" [moduleId]="moduleId" [runId]="schemaInfo.runId"
                                [activeTab]="activeTab" (groupChange)="updateSelectedGroup($event)">
                            </pros-group-data-table>
                        </div>
                        <mat-divider [vertical]="true"></mat-divider>
                        <div class="f-col dataset-grid-listing">
                            <div class="f-row">
                                <lib-search placeholder="Search..." (value)="inlineSearchSubject.next($event);"></lib-search>
                                <div class="f-col-spacer-half"></div>
                                <mat-chip-list>
                                    <!-- Applied filters -->
                                    <ng-template ngFor let-ctrl [ngForOf]="filterCriteria | async">
                                        <ng-template [ngIf]="ctrl.type !== 'INLINE'">
                                            <div class="f-col-spacer-half"></div>
                                            <mat-chip class="mdo-filter-matchip" disableRipple="true"
                                                [matMenuTriggerFor]="appliedfiltermenu" (click)="loadDropValues(ctrl)">
                                                <label>
                                                    {{ ctrl.filterCtrl ? ctrl.filterCtrl.fldCtrl.fieldDescri : 'Unknown'
                                                    }}
                                                    :
                                                </label>
                                                <ng-template [ngIf]="ctrl.filterCtrl.selectedValues.length > 1"
                                                    [ngIfElse]="showText">
                                                    <span class="info">
                                                        {{ prepareTextToShow(ctrl) }}
                                                    </span>
                                                </ng-template>
                                                <ng-template #showText>
                                                    <span class="info">
                                                        {{ prepareTextToShow(ctrl)}}
                                                    </span>
                                                </ng-template>
                                                <mat-icon matChipRemove (click)="removeAppliedFilter(ctrl)">clear
                                                </mat-icon>
                                            </mat-chip>
                                            <!-- Append dynamic filter MatMenu -->
                                            <mat-menu #appliedfiltermenu="matMenu">
                                                <pros-filter-values [moduleId]="moduleId"
                                                    [fieldId]="loadDopValuesFor ? loadDopValuesFor.fieldId : ''"
                                                    [checkedValue]="loadDopValuesFor ? loadDopValuesFor.checkedValue : []"
                                                    (selectedValues)="updateFilterCriteria($event)">
                                                </pros-filter-values>
                                            </mat-menu>
                                        </ng-template>
                                    </ng-template>

                                    <!-- Add filter control -->
                                    <mat-chip class="mdo-filter-matchip" disableRipple="true"
                                        [matMenuTriggerFor]="addfiltermenu" (click)="reInilize = !reInilize">
                                        <mat-icon fontSet="mdo-icons-light">filter</mat-icon>
                                    </mat-chip>

                                    <!-- Add filter control MatMenu -->
                                    <mat-menu #addfiltermenu="matMenu">
                                        <pros-add-filter-menu [moduleId]="moduleId"
                                            (evtReadyForApply)="makeFilterControl($event)" [reInilize]="reInilize"
                                            [alreadySelectedValues]="filterCriteria.getValue()">
                                        </pros-add-filter-menu>
                                    </mat-menu>
                                </mat-chip-list>
                            </div>

                            <div class="row-spacer"></div>

                            <div class="f-row action-iconbtns"
                                *ngIf="tableHeaderActBtn.length && activeTab === 'review'">
                                <ng-template [ngIf]="(isReviewer || isApprover) && isGlobalActionsEnabled">
                                    <lib-button type="minor" (click)="approveRecords('global')"> Approve </lib-button>
                                    <lib-button type="minor" (click)="rejectRecords('global')"> Reject </lib-button>
                                </ng-template>
                                <lib-button type="minor" (click)="selection.clear()"> Unselect </lib-button>    
                            </div>

                            <!-- Data Table -->
                            <div class="data" (scroll)="onScroll($event)">
                                <mat-table [dataSource]="dataSource" matSort class="mat-elevation-z0">
                                    <!-- Checkbox Column -->
                                    <ng-container matColumnDef="select" sticky>
                                        <mat-header-cell *matHeaderCellDef class="fixed-width-c1">
                                            <mat-checkbox (change)="$event ? masterToggle() : null"
                                                [checked]="selection.hasValue() && isAllSelected()"
                                                [indeterminate]="selection.hasValue() && !isAllSelected()"
                                                [aria-label]="checkboxLabel()" color="primary">
                                            </mat-checkbox>
                                        </mat-header-cell>
                                        <mat-cell class="fixed-width-c1" *matCellDef="let row">
                                            <mat-checkbox (click)="$event.stopPropagation()"
                                                (change)="$event ? selection.toggle(row) : null"
                                                [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)"
                                                color="primary">
                                            </mat-checkbox>
                                        </mat-cell>
                                    </ng-container>

                                    <!-- Avatar Column -->
                                    <ng-container matColumnDef="avatar">
                                        <mat-header-cell *matHeaderCellDef class="fixed-width-c1"></mat-header-cell>
                                        <mat-cell class="fixed-width-c1" *matCellDef="let element">
                                            <mat-card-header>
                                                <div mat-card-avatar>AK</div>
                                            </mat-card-header>
                                        </mat-cell>
                                    </ng-container>

                                    <!-- Actions Column -->
                                    <ng-container matColumnDef="action" sticky>
                                        <mat-header-cell *matHeaderCellDef class="action-width">
                                            <lib-button type="plain" (click)="openTableColumnSettings()" icon="cog">
                                            </lib-button>
                                        </mat-header-cell>
                                        <mat-cell *matCellDef="let element" class="action-width no-text-decoration">
                                            <div class="f-row">
                                                <ng-template [ngIf]="activeTab !== 'review'" [ngIfElse]="review">
                                                    <lib-button-group>
                                                        <lib-button icon="ellipsis-h" type="minor" [matMenuTriggerFor]="moreactions"></lib-button>
                                                        <!-- more actions menu -->
                                                        <mat-menu #moreactions="matMenu" class="navigation-menu">
                                                            <!-- <button mat-menu-item>Create HERS</button>
                                                            <button mat-menu-item>Create info record</button>
                                                            <mat-divider></mat-divider>
                                                            <button mat-menu-item>Assign to...</button> -->
                                                            <button mat-menu-item (click)="markForDeletion(element)">Mark
                                                                for deletion</button>
                                                        </mat-menu>

                                                        <ng-container *ngIf="element && element[RECORD_STATUS_KEY] && (element[RECORD_STATUS_KEY].fieldData === RECORD_STATUS.MASTER); else notMaster">
                                                            <lib-button type="minor" icon="star"></lib-button>
                                                        </ng-container>
                                                        <ng-template #notMaster>
                                                            <lib-button type="minor" icon="star" (click)="markAsMasterRecord(element)"></lib-button>
                                                        </ng-template>

                                                        <lib-button type="minor" *ngIf="element && element[RECORD_STATUS_KEY] && (element[RECORD_STATUS_KEY].fieldData === RECORD_STATUS.DELETABLE)" icon="redo-alt"></lib-button>
                                                        <lib-button type="minor" *ngIf="element && element[RECORD_STATUS_KEY] && (element[RECORD_STATUS_KEY].fieldData !== RECORD_STATUS.DELETABLE)"
                                                        (click)="markForDeletion(element)" icon="trash-alt"></lib-button>
                                                    </lib-button-group>
                                                </ng-template>
                                                
                                                <ng-template #review>
                                                    <!-- Secondary actions -->

                                                    <ng-template
                                                        [ngIf]="!element['OBJECTNUMBER'].isReviewed && (element[RECORD_STATUS_KEY].fieldData !== RECORD_STATUS.DELETABLE)">
                                                        <lib-button *ngIf="secondaryActions.length" [matMenuTriggerFor]="secondaryActionsMenu" type="minor" icon="ellipsis-h"></lib-button>
                                                        <mat-menu #secondaryActionsMenu="matMenu"
                                                            class="navigation-menu">
                                                            <ng-container *ngFor="let sAction of secondaryActions">
                                                                <button mat-menu-item
                                                                    *ngIf="hasActionPermission(sAction)"
                                                                    (click)="doAction(sAction, element)">
                                                                    <mat-icon fontSet="mdo-icons"
                                                                        *ngIf="!sAction.isCustomAction && (sAction.actionViewType=== TableActionViewType.ICON || sAction.actionViewType=== TableActionViewType.ICON_TEXT)">
                                                                        {{ sAction.actionIconLigature }}
                                                                    </mat-icon>
                                                                    <ng-template
                                                                        [ngIf]="(sAction.actionViewType === TableActionViewType.TEXT) || (sAction.actionViewType === TableActionViewType.ICON_TEXT)">
                                                                        {{ sAction.actionText }}
                                                                    </ng-template>
                                                                </button>
                                                            </ng-container>
                                                        </mat-menu>
                                                        <!-- Primary actions -->
                                                        <ng-container *ngFor="let pAction of primaryActions">
                                                            <button mat-flat-button color="accent"
                                                                *ngIf="hasActionPermission(pAction)"
                                                                (click)="doAction(pAction, element)">
                                                                <mat-icon fontSet="mdo-icons"
                                                                    *ngIf="(pAction.actionViewType=== TableActionViewType.ICON) || (pAction.actionViewType=== TableActionViewType.ICON_TEXT)">
                                                                    {{ pAction.actionIconLigature }}
                                                                </mat-icon>
                                                                <ng-template
                                                                    [ngIf]="(pAction.actionViewType=== TableActionViewType.TEXT) || (pAction.actionViewType=== TableActionViewType.ICON_TEXT)">
                                                                    {{ pAction.actionText }}
                                                                </ng-template>
                                                            </button>
                                                        </ng-container>
                                                    </ng-template>
                                                </ng-template>
                                            </div>
                                        </mat-cell>
                                    </ng-container>

                                    <ng-container matColumnDef="OBJECTNUMBER" sticky>
                                        <mat-header-cell *matHeaderCellDef mat-sort-header> Object Number
                                        </mat-header-cell>
                                        <mat-cell *matCellDef="let element">
                                            {{ element['OBJECTNUMBER'] ? element['OBJECTNUMBER'].fieldData : '' }}
                                        </mat-cell>
                                    </ng-container>

                                    <!-- Status Column -->
                                    <ng-container [matColumnDef]="RECORD_STATUS_KEY">
                                        <mat-header-cell *matHeaderCellDef mat-sort-header> Status
                                        </mat-header-cell>
                                        <mat-cell *matCellDef="let element" class="no-text-decoration">
                                            <mat-chip-list>
                                                <mat-chip disableRipple="true" class="badge"
                                                    [ngClass]="getRecordStatusClass(element)">
                                                    {{ element[RECORD_STATUS_KEY] ? element[RECORD_STATUS_KEY].fieldData
                                                    : '' }}
                                                    &nbsp;<mat-icon fontSet="mdo-icons" class="mat-info-icon">
                                                        info
                                                    </mat-icon>
                                                </mat-chip>
                                            </mat-chip-list>
                                        </mat-cell>
                                    </ng-container>

                                    <ng-template ngFor let-dynCol [ngForOf]="displayedFields | async">
                                        <ng-template [ngIf]="isStaticColumn(dynCol)" [ngIfElse]="dynamic">
                                        </ng-template>
                                        <ng-template #dynamic>
                                            <ng-container [matColumnDef]="dynCol">
                                                <mat-header-cell *matHeaderCellDef mat-sort-header>
                                                    {{ metadataFldLst && metadataFldLst.headers[dynCol] ?
                                                    metadataFldLst.headers[dynCol].fieldDescri : 'Unknown' }}
                                                </mat-header-cell>
                                                <!-- <mat-cell *matCellDef="let element">
                                                {{ element[dynCol] ? element[dynCol].fieldData : '' }}
                                            </mat-cell> -->

                                                <mat-cell *matCellDef="let element; let rIndex = index;"
                                                    [class.error-cell]="element[dynCol] ? element[dynCol].isInError : false"
                                                    (click)="editCurrentCell(dynCol,element, rIndex, containerRef)">
                                                    <div class="f-col grid-cell-editable">
                                                        <div class="mdo-form-input f-col" style="display: none;"
                                                            id="inpctrl_{{ dynCol + '_' + rIndex }}">

                                                            <!-- container to hold input field when cell gets edited  -->
                                                            <ng-template prosContainerRef
                                                                #containerRef="prosContainerRef">
                                                            </ng-template>
                                                        </div>
                                                        <ng-template
                                                            [ngIf]="element[dynCol] && element[dynCol].isCorrected"
                                                            [ngIfElse]="normalCell">
                                                            <ng-template
                                                                [ngIf]="element[dynCol].oldData !== element[dynCol].fieldData"
                                                                [ngIfElse]="other">
                                                                <div class="f-col">
                                                                    <span id="viewctrl_{{ dynCol + '_' + rIndex }}">
                                                                        {{ element[dynCol] ? formatCellData(dynCol,
                                                                        element[dynCol].fieldData) : '' }}
                                                                    </span>
                                                                    <span class="text-correction">
                                                                        {{ element[dynCol] ? formatCellData(dynCol,
                                                                        element[dynCol].oldData) : '' }}
                                                                    </span>
                                                                </div>

                                                            </ng-template>
                                                            <ng-template #other>
                                                                <div class="f-col">
                                                                    <span id="viewctrl_{{ dynCol + '_' + rIndex }}">
                                                                        {{ element[dynCol] ? formatCellData(dynCol,
                                                                        element[dynCol].fieldData) : '' }}
                                                                    </span>
                                                                </div>
                                                            </ng-template>
                                                        </ng-template>
                                                        <ng-template #normalCell>
                                                            <div class="f-col">
                                                                <span id="viewctrl_{{ dynCol + '_' + rIndex }}">
                                                                    {{ element[dynCol] ? formatCellData(dynCol,
                                                                    element[dynCol].fieldData) : '' }}
                                                                </span>
                                                                <span class="text-correction">
                                                                    {{ element[dynCol] ? element[dynCol].errorMsg : ''
                                                                    }}
                                                                </span>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </mat-cell>

                                            </ng-container>
                                        </ng-template>
                                    </ng-template>

                                    <!-- load header for actions-->
                                    <ng-container matColumnDef="common_actions_header">
                                        <mat-header-cell *matHeaderCellDef
                                            [attr.colspan]="displayedFields.getValue().length">
                                            <div class="f-row action-iconbtns">
                                                <lib-button type="plain" icon="check"> Action </lib-button>
                                                <lib-button (click)="selection.clear()" type="plain" icon="times"></lib-button>
                                            </div>
                                        </mat-header-cell>
                                    </ng-container>

                                    <!-- <mat-header-row *matHeaderRowDef="tableHeaderActBtn; sticky : true"></mat-header-row> -->
                                    <mat-header-row *matHeaderRowDef="displayedFields | async; sticky: true">
                                    </mat-header-row>
                                    <mat-row *matRowDef="let row; columns: displayedFields | async;"
                                        [ngClass]="getTableRowClass(row)"></mat-row>
                                </mat-table>
                                <pros-null-state *ngIf="!dataSource.docLength()" [button]="null" [iconWidth]="400">
                                </pros-null-state>

                            </div>
                        </div>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </div>
    </ng-template>
</div>