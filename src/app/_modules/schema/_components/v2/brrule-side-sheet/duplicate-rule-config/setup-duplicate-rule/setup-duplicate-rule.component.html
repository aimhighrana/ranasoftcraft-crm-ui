<form [formGroup]="duplicateRuleForm">
    <div class="f-col">
        <mat-accordion>
            <mat-expansion-panel togglePosition="before" class="mat-elevation-z0" expanded>
                <mat-expansion-panel-header expandedHeight="36px" collapsedHeight="36px">
                    <mat-panel-title>
                        <lib-text-line type="base" weight="strong" i18n="@@fields">Fields</lib-text-line>
                    </mat-panel-title>
                </mat-expansion-panel-header>

                <div class="colunm-listing">
                    <div class="f-row colunm-box rule-border-row">
                        <div class="col"></div>
                        <div class="col col-x4">
                            <lib-text-line type="small" weight="strong" i18n="@@field">Field</lib-text-line>
                        </div>
                        <div class="col col-x4">
                            <lib-text-line type="small" weight="strong" i18n="@@match">Match <mat-icon
                                i18n-libTooltip="@@match" libTooltip="match" fontSet="mdo-icons"
                                class="mat-head-icon">
                                question-circle</mat-icon>
                        </lib-text-line>
                        </div>
                        <div class="col col-x4">
                            <lib-text-line type="small" weight="strong" i18n="@@exclusions">Exclusions <mat-icon
                                libTooltip="exclusions" i18n-libTooltip="@@exclusions" fontSet="mdo-icons"
                                class="mat-head-icon">
                                question-circle</mat-icon>
                        </lib-text-line>
                        </div>
                        <div class="col mat-item-end"></div>
                    </div>

                    <div class="f-row-spacer-half"></div>

                    <div class="f-col mdo-field">
                        <mat-form-field appearance="outline">
                            <input matInput placeholder="Type field name to add" formControlName="fieldSearch"
                                [matAutocomplete]="auto" />
                            <mat-autocomplete #auto="matAutocomplete" [displayWith]="getFieldDesc">
                                <mat-option *ngFor="let field of duplicateFieldsObs | async"
                                    (click)="addFieldRecord(field.fieldId)" [value]="field.fieldId">
                                    {{ field.fieldDescri }}
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>

                    <ng-container formArrayName="addFields">
                        <div cdkDropList (cdkDropListDropped)="dropField($event)">
                            <div *ngFor="let item of fieldRecords.controls; let i = index"
                                class="f-row colunm-box rule-border-row" cdkDrag>

                                <ng-container [formGroupName]="i">
                                    <div class="col">
                                        <lib-button cdkDragHandle icon="grip-lines"></lib-button>
                                    </div>
                                    <div class="col col-x4">
                                        <lib-text-line type="base">{{ getFieldDesc(item.value.fId)}}</lib-text-line>
                                    </div>
                                    <div class="col col-x4">
                                        <div class="f-col">
                                            <lib-button [matMenuTriggerFor]="fieldMatchMenu">
                                                {{ getDuppCriteriaDesc(item.value.criteria) }}
                                                <mat-icon fontSet="mdo-icons-solid">caret-down</mat-icon></lib-button>
                                        <mat-menu #fieldMatchMenu="matMenu" class="navigation-menu">
                                                <button mat-menu-item
                                                    (click)="setControlValue('addFields', 'criteria', 'Exact_Match', i)">
                                                    Exact Match</button>
                                                <button mat-menu-item
                                                    (click)="setControlValue('addFields', 'criteria', 'Fuzzy', i)">
                                                    Fuzzy </button>
                                            </mat-menu>
                                            <mat-error i18n="@@pls_select_value"
                                                *ngIf="submitted && item.get('criteria').errors && item.get('criteria').errors.required">
                                                Please select value</mat-error>
                                        </div>
                                    </div>
                                    <div class="col col-x4"> 
                                        <lib-text-line type="base" textColor="link" (click)="exclusionConf(item)" class="cursor">{{
                                            item.value.exclusion }}</lib-text-line>
                                    </div>
                                    <div class="col mat-item-end">
                                        <lib-button (click)="removeFormArrayRow('addFields', i)" icon="trash-alt">
                                        </lib-button>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>
                    <lib-empty-state *ngIf="fieldRecords.controls.length === 0" i18n-primaryText="@@nothing_to_see_here" primaryText="Nothing to see here" i18n-secondaryText="@@type_inside_search_box_to_find_fields" secondaryText="Type inside the search box to find fields" icon="table" iconSize="100"></lib-empty-state>
                </div>
            </mat-expansion-panel>
        </mat-accordion>

        <mat-accordion>
            <mat-expansion-panel togglePosition="before" class="mat-elevation-z0">
                <mat-expansion-panel-header expandedHeight="36px" collapsedHeight="36px">
                    <mat-panel-title>
                        <lib-text-line type="base" weight="strong" i18n="@@master_record_parameters">Master record parameters</lib-text-line>
                    </mat-panel-title>
                </mat-expansion-panel-header>

                <div class="colunm-listing">
                    <div class="f-row colunm-box rule-border-row">
                        <div class="col col-x4">
                            <lib-text-line type="small" weight="strong" i18n="@@parameter">Parameter</lib-text-line>
                        </div>
                        <div class="col col-x4">
                            <lib-text-line type="small" weight="strong" i18n="@@attribute">Attribute</lib-text-line>
                        </div>
                        <div class="col mat-item-end"></div>
                    </div>

                    <div class="f-row-spacer-half"></div>

                    <div class="f-col mdo-field">
                        <mat-form-field appearance="outline">
                            <input matInput placeholder="Type parameter name to add" [matAutocomplete]="paramAuto" />
                            <mat-autocomplete #paramAuto="matAutocomplete">
                                <mat-option *ngFor="let ruleType of MERGE_RULE_TYPES"
                                    (click)="addMasterRecord(ruleType.value)"> {{ ruleType.label }}
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>
                    
                    <ng-container formArrayName="mergeRules">
                        <div *ngFor="let item of masterRecords.controls; let i = index"
                            class="f-row colunm-box rule-border-row">

                            <ng-container [formGroupName]="i">
                                <div class="col col-x4">
                                    <lib-text-line type="base">{{ getMergeRuleTypeDesc(item.value.ruleType) }}</lib-text-line>
                                </div>
                                <div class="col col-x4">
                                    <div class="f-col">
                                        <ng-template
                                            [ngIf]="(item.value.ruleType === 'NEWEST') || (item.value.ruleType === 'OLDEST')"
                                            [ngIfElse]="others">
                                            <button mat-stroked-button [matMenuTriggerFor]="fieldMatchMenu">
                                                {{ getMergeRuleFieldDesc(item.value.fieldId) }}
                                                <mat-icon fontSet="mdo-icons-solid">caret-down</mat-icon></button>
                                        <mat-menu #fieldMatchMenu="matMenu" class="navigation-menu">
                                                <button mat-menu-item *ngFor="let field of MERGE_RULE_FIELDS"
                                                    (click)="setFieldValue(item.value.ruleType, field.value, i)">
                                                    {{ field.label }} </button>
                                            </mat-menu>
                                        </ng-template>

                                        <ng-template #others>
                                            <lib-button [matMenuTriggerFor]="searchFieldMenu">
                                                {{ item.value.fieldId ? getFieldDesc(item.value.fieldId) : 'select' }}
                                                <mat-icon fontSet="mdo-icons-solid">caret-down</mat-icon></lib-button>
                                                <!-- field search menu -->
                                                <mat-menu #searchFieldMenu="matMenu" class="navigation-menu">
                                                <div class="fields-menu">
                                                    <pros-search-input (value)="input.value = $event"
                                                        prosClickStopPropagation></pros-search-input>
                                                    <input #input hidden />
                                                    <mat-nav-list>
                                                        <ng-template [ngIf]="filterNumFields(input.value).length"
                                                            [ngIfElse]="noNumeric">
                                                            <mat-list-item
                                                                *ngFor="let fieldItem of filterNumFields(input.value)"
                                                                (click)="setFieldValue(item.value.ruleType, fieldItem.fieldId, i)">
                                                                {{fieldItem.fieldDescri}}
                                                            </mat-list-item>
                                                        </ng-template>
                                                        <ng-template #noNumeric>
                                                            <pros-null-state message="" [button]="null"></pros-null-state>
                                                        </ng-template>
                                                    </mat-nav-list>
                                                </div>
                                            </mat-menu>
                                            <!-- <mat-form-field appearance="outline">
                                            <input matInput placeholder="Type field name to add" #input
                                                   formControlName="fieldId"
                                                   [matAutocomplete]="auto" />
                                            <mat-autocomplete #auto="matAutocomplete" [displayWith]="getFieldDesc">
                                                <mat-option *ngFor="let field of filter(input.value)" [value]="field.fieldId">
                                                    {{ field.fieldDescri }}
                                                </mat-option>
                                              </mat-autocomplete>
                                        </mat-form-field> -->
                                        </ng-template>
                                        <mat-error i18n="@@pls_select_field"
                                            *ngIf="submitted && item.get('fieldId').errors && item.get('fieldId').errors.required">
                                            Please select field</mat-error>
                                    </div>
                                </div>
                                <div class="col mat-item-end">
                                    <lib-button (click)="removeFormArrayRow('mergeRules', i)" icon="trash-alt">
                                    </lib-button>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>
                    <lib-empty-state *ngIf="masterRecords.controls.length === 0" i18n-primaryText="@@nothing_to_see_here" primaryText="Nothing to see here" i18n-secondaryText="@@type_inside_search_box_to_find_master" secondaryText="Type inside the search box to find master records" icon="table" iconSize="100"></lib-empty-state>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
    </div>

    <!-- <div class="f-col temp-field">
        <mat-accordion>
            <mat-expansion-panel togglePosition="before" class="mat-elevation-z0">
                <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
                    <mat-panel-title class="panel-title">
                        Master record parameters
                    </mat-panel-title>
                </mat-expansion-panel-header>

                <div class="colunm-listing">

                    <div class="f-row colunm-box rule-border-row">
                        <div class="col col-x4"> <mat-label>Parameter</mat-label></div>
                        <div class="col col-x4"> <mat-label> Attribute </mat-label></div>
                        <div class="col col-x4"></div>
                        <div class="col"></div>
                    </div>

                    <div class="f-col mdo-form-field">
                            <mat-form-field appearance="outline">
                                <input matInput placeholder="Type parameter name to add"
                                       [matAutocomplete]="paramAuto" />
                                <mat-autocomplete #paramAuto="matAutocomplete">
                                    <mat-option *ngFor="let field of filter(input.value)" (click)="addSelectionRow(field.fieldId)">
                                        {{ field.fieldDescri }}
                                    </mat-option>
                                  </mat-autocomplete>
                            </mat-form-field>
                    </div>
                    <ng-container formArrayName="selCriteria">
                        <div *ngFor="let item of duplicateRuleForm.get('selCriteria').controls; let i = index"
                            class="f-row colunm-box rule-border-row">

                            <ng-container [formGroupName]="i">
                                <div class="col col-x4">
                                    <div mat-line> {{ getFieldDesc(item.value.fldId)}} </div>
                                </div>
                                <div class="col col-x4">
                                    <button mat-stroked-button [matMenuTriggerFor]="fieldMatchMenu">
                                        {{ item.value.selection }}
                                            <mat-icon>arrow_drop_down</mat-icon></button>
                                    <mat-menu #fieldMatchMenu="matMenu" class="hidden-arrow">
                                        <button mat-menu-item (click)="setControlValue('selCriteria', 'selection', 'Pick_From_The_Record', i)" > Pick From The Record </button>
                                        <button mat-menu-item (click)="setControlValue('selCriteria', 'selection', 'Custom', i)"> Custom </button>
                                    </mat-menu>
                                </div>
                                <div class="col col-x4">
                                    <mat-form-field appearance="outline" *ngIf="item.value.selection === 'Custom'">
                                        <input matInput formControlName="txtVal" />
                                    </mat-form-field>
                                </div>
                                <div class="col">
                                    <button mat-button (click)="removeFormArrayRow('selCriteria', i)">
                                        <mat-icon>delete_outline</mat-icon>
                                    </button>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
    </div> -->
</form>