<div class="root">
    <div class="f-row breadcrum-toolbar">
        <lib-button type="plain" (click)="close()" iconFontType="light" icon="times"></lib-button>
        <div class="col-spacer"></div>
        <div class="f-col mdo-constrained-right">
            <div class="f-row breadcrum-head">
                <div class="display-heading-large" *ngIf="!isFromCheckData; else fromPrimaryNav">
                    {{schemaDetails?.moduleDescription ? schemaDetails.moduleDescription : 'Untitled'}} /
                    {{schemaDetails?.schemaDescription ? schemaDetails.schemaDescription: 'Untitled'}}
                </div>
                <ng-template #fromPrimaryNav>
                    <div class="display-heading-large">
                        {{moduleDesc ? moduleDesc : 'Untitled'}} /
                        {{schemaDetails?.schemaDescription ? schemaDetails.schemaDescription: 'Untitled'}}
                    </div>
                </ng-template>

                <!-- <button mat-button [matMenuTriggerFor]="check">
                    <mat-icon fontSet="mdo-icons">menu-arrow</mat-icon>
                </button> -->
    
                <!-- <mat-menu #check="matMenu"> 
                    <button mat-menu-item [matMenuTriggerFor]="customermenu">Customer</button>
                    <button mat-menu-item>Material</button>
                    <button mat-menu-item>Order</button>
                    <button mat-menu-item>Vendor</button>
                  </mat-menu>
    
                  <mat-menu #customermenu="matMenu">
                    <button mat-menu-item>Customer one</button>
                    <button mat-menu-item>Customer two</button>
                    <button mat-menu-item>Customer three</button>
                    <button mat-menu-item>Customer four</button>
                  </mat-menu> -->
                <span class="f-col-spacer-half"></span>
                <span class="f-spacer"></span>
                <lib-button (click)="openUploadSideSheet()" type="plain" iconPosition="before" icon="upload"> Upload data </lib-button>
                <span class="f-col-spacer-half"></span>
                <lib-button (click)="saveCheckData()" type="major">Check</lib-button>
            </div>
        </div>
    </div>
    <div class="f-col sidesheetcontent-listing">
        <div class="f-col mdo-justify">
            <div class="f-col">
                <div class="f-col mdo-form-field" *ngIf="isFromCheckData">
                    <lib-input i18n-label="@@schema_name" label="Schema name" [type]="'text'"  placeholder="Schema name" [value]="schemaDetails.schemaDescription" [formControl]="schemaName">
                    </lib-input>
                </div>

                <div class="f-col mdo-form-field">
                    <mat-label i18n="@@data_scope">Data scope</mat-label>
                    <mat-form-field appearance="outline">
                        <mat-select [formControl]="dataScopeControl">
                            <mat-option i18n="@@add_data_scope" (click)="openDataScopeSideSheet()">Add data scope</mat-option>
                            <mat-divider></mat-divider>
                            <mat-option value='0' i18n="@@entire_data_scope">Entire data scope</mat-option>
                            <mat-option *ngFor="let variant of variantDetails" [value]="variant.variantId">
                                {{variant.variantName}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="f-col mdo-form-field">
                    <mat-label i18n="@@threshold">Threshold</mat-label>
                    <div class="f-row slider-row">
                    <lib-range-slider class="lib-slider" thumbLabel="true" [formControl]="schemaThresholdControl"  tickInterval="1" [formatLabelFn]="rangeSliderLabelFormat" [value]="schemaThresholdControl.value" color="primary"></lib-range-slider>

                    <span class="f-col-spacer-half"></span>
                    <div>{{schemaThresholdControl.value}}%</div>
                    </div>
                </div>  
                <mat-accordion>
                    <mat-expansion-panel togglePosition="before" class="mat-elevation-z0">
                        <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
                            <mat-panel-title class="panel-title">
                                <span i18n="@@business_rules">Business rules</span> ({{getBusinessRulesLength}})
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <!-- Business rule listing latest code start here-->
                        <div class="colunm-listing">
                            <div class="f-row colunm-box rule-border-row">
                                <div class="col"></div>
                                <div class="col col-x8"><strong i18n="@@business_rule">Business rule</strong></div>
                                <div class="col col-x8 text-center"><strong class="f-row"><span i18n="@@weightage">Weightage</span>
                                        <mat-icon i18n-libTooltip="@@br_weightage_tooltip_msg" libTooltip="Score assigned to a record upon successful validation of a business rule.For a schema total weightage of all the business rules must not exceed 100" fontSet="mdo-icons" class="mat-head-icon">
                                            question-circle</mat-icon>
                                    </strong></div>
                                <div class="col col-x4"><strong i18n="@@enabled">Enabled</strong></div>
                                <div class="col col-x4 text-end"></div>
                            </div>

                            <div class="f-row colunm-box rule-border-row">
                                <div class="mdo-auto-select">
                                    <pros-form-input-autoselect i18n-fieldLabel="@@type_rule_name_to_add" fieldLabel="Type rule name to add"
                                        (openCustomDialog)="openBrLibrarySideSheet()"
                                        [updatedOptionsList]="allBusinessRulesList" 
                                        [labelKey]="'brInfo'"
                                        (optionSelectedEmit)="addBusinessRule($event)"
                                        i18n-extraOptionLabel="@@add_br_rule" extraOptionLabel="Add new business rule"
                                        [isExtraLabel]="false"></pros-form-input-autoselect>
                                        <!-- (emitExtraLabelClick)="openBusinessRuleSideSheet()" -->
                                </div>
                            </div>

                            <ng-template [ngIf]="businessRuleData.length>0" [ngIfElse]="brsNullState">
                                <div cdkDropList [cdkDropListData]="businessRuleData"  (cdkDropListDropped)="drop($event)">
                                <div cdkDrag *ngFor="let businessRule of businessRuleData; let i=index" >
                                   <div  class="f-row colunm-box rule-border-row">
                                    <div class="col">
                                        <lib-button cdkDragHandle type="plain" iconFontType="solid" icon="grip-lines"></lib-button>
                                    </div>
                                    <div class="col col-x8">
                                        <a class="f-row info-link">{{businessRule.brInfo}}</a>
                                    </div>

                                    <div class="col col-x8">
                                        <div class="f-row slider-row">
                                        <lib-range-slider minValue="0" (valueChange)="updateBr(businessRule,$event)" [maxValue]="availableWeightage(businessRule.brWeightage)" class="lib-slider" thumbLabel="true" tickInterval="1" [formatLabelFn]="rangeSliderLabelFormat" [value]="businessRule.brWeightage" color="primary"></lib-range-slider>
                                        <span class="f-col-spacer-half"></span>
                                        <div class="percent-count">{{businessRule.brWeightage}}%</div>
                                    </div>
                                    </div>

                                    <div class="col col-x4">
                                        <lib-checkbox color="primary" [checked]="businessRule.status === '1'" (valueChange)="updateBr(businessRule, $event, 'checkbox')"></lib-checkbox>
                                    </div>

                                    <div class="col col-x4 text-end">
                                        <lib-button type="plain" [matMenuTriggerFor]="mappingdependency" [disabled]='i===0 ' iconFontType="light" icon="link"></lib-button>
                        
                                        <!-- Mapping Dropdown Menu -->
                                        <mat-menu #mappingdependency="matMenu" #aboveMenu="matMenu" yPosition="above" xPosition="before" class="mat-elevation-z0 tooltip-fields-menu">
                                            <!-- <div class="top-tiparrow"></div> -->
                                            <div class="f-col">
                                                <p i18n="@@run_rule_warning_msg">Only run this rule if  the preceding rule returns</p>
                                                <lib-radio-group (click)="$event.stopPropagation()" [options]="depRuleList" class="f-col" color="primary"  [value]="getCurrentBrStatusObj(businessRule.dependantStatus)" (valueChange)="updateDepRule(businessRule,$event)"></lib-radio-group>
                                            </div>
                                        </mat-menu>
                                        <lib-button type="plain" (click)="deleteBr(businessRule)"  icon="trash-alt"></lib-button>
                                    </div>
                                </div>
                                <div cdkDropList [cdkDropListData]="businessRule.dep_rules"  (cdkDropListDropped)="drop($event)">
                                    <div cdkDrag *ngFor="let deps of businessRule.dep_rules;let i=index;" >
                                        <div class="f-row colunm-box rule-border-row">
                                        <div class="col">
                                            <lib-button type="plain" cdkDragHandle iconFontType="light" icon="subdirectory_arrow_right"></lib-button>
                                            
                                        </div>
                                        <div class="col col-x8">
                                            <a class="f-row info-link">{{deps.brInfo}}</a>
                                        </div>
    
                                        <div class="col col-x8">
                                            <div class="f-row slider-row">
                                                <lib-range-slider minValue="0" [maxValue]="availableWeightage(deps.brWeightage)" (valueChange)="updateBr(deps,$event)" class="lib-slider" thumbLabel="true" tickInterval="1" [formatLabelFn]="rangeSliderLabelFormat" [value]="deps.brWeightage" color="primary"></lib-range-slider>
                                            <span class="f-col-spacer-half"></span>
                                            <div class="percent-count">{{deps.brWeightage}}%</div>
                                        </div>
                                        </div>
    
                                        <div class="col col-x4">
                                            <lib-checkbox color="primary" [checked]="deps.status === '1'" (valueChange)="updateBr(deps, $event, 'checkbox')"></lib-checkbox>
                                        </div>
    
                                        <div class="col col-x4 text-end">
                                            <lib-button type="plain" [matMenuTriggerFor]="mappingdependency" iconFontType="light" icon="link"></lib-button>
                        
                                            <!-- Mapping Dropdown Menu -->
                                            <mat-menu #mappingdependency="matMenu" #aboveMenu="matMenu" yPosition="above" xPosition="before" class="mat-elevation-z0 tooltip-fields-menu">
                                                <!-- <div class="top-tiparrow"></div> -->
                                                <div class="f-col">
                                                        <p i18n="@@run_rule_warning_msg">Only run this rule if  the preceding rule returns</p>
                                                        <lib-radio-group (click)="$event.stopPropagation()" [options]="depRuleList" class="f-col" color="primary"  [value]="getCurrentBrStatusObj(deps.dependantStatus)" (valueChange)="updateDepRuleForChild(businessRule,i, $event)"></lib-radio-group>
                                                    </div>
                                            </mat-menu>
                                           <lib-button type="plain" (click)="deleteBrChild(deps,businessRule)" iconFontType="light" icon="trash-alt"></lib-button>
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                                </div>
                        </div>
  
                        
                            </ng-template>

                            <ng-template #brsNullState>
                                <lib-empty-state i18n-primaryText="@@nothing_to_see_here" primaryText="Nothing to see here" i18n-secondaryText="@@brs_null_message" [secondaryText]="brsNullMessage" icon="table"iconSize="100"></lib-empty-state>
                            </ng-template>
                        </div>
                        <!-- Business rule listing latest code end here-->
                    </mat-expansion-panel>
                </mat-accordion>
                <div class="row-spacer"></div>
                <mat-accordion>
                    <mat-expansion-panel togglePosition="before" class="mat-elevation-z0">
                        <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
                            <mat-panel-title class="panel-title">
                                <span i18n="@@subscribers">Subscribers</span> ({{subscriberData ? subscriberData.length : 0}})
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <!-- Subscribers listing latest code start here-->
                        <div class="colunm-listing">
                            <div class="f-row colunm-box rule-border-row">
                                <div class="col"></div>
                                <div class="col col-x8"><strong i18n="@@subscriber">Subscriber</strong></div>
                                <div class="col col-x4"><strong i18n="@@role">Role</strong></div>
                                <div class="col col-x16"><strong i18n="@@data_allocation">Data allocation</strong></div>
                                <div class="col">
                                </div>
                            </div>

                            <div class="f-row colunm-box rule-border-row">
                                <div class="mdo-auto-select">
                                    <pros-form-input-autoselect
                                    i18n-fieldLabel="@@type_subscriber_name" fieldLabel="Type subscriber name to add"
                                        (openCustomDialog)="openSubscriberSideSheet()" 
                                        [updatedOptionsList]="allSubscribers"
                                        [labelKey]="'fullName'"
                                        (optionSelectedEmit)="addSubscriber($event)"
                                        i18n-extraOptionLabel="@@invite_people_to_team" extraOptionLabel="Invite people to your team">
                                    </pros-form-input-autoselect>
                                </div>
                            </div>

                            <ng-template [ngIf]="subscriberData.length>0" [ngIfElse]="subscriberNullState">
                                <div class="f-row colunm-box rule-border-row" *ngFor="let subscriber of subscriberData">
                                    <div class="col">
                                    <ng-template [ngIf]="subscriber.userMdoModel && subscriber.isInvited!==true" [ngIfElse]="invitedUserProfile">
                                        <lib-avatar [initials]="shortName(subscriber.userMdoModel.fName, subscriber.userMdoModel.lName)"></lib-avatar>
                                        <mat-card-header *ngIf="false">
                                            <div mat-card-avatar *ngIf="subscriber.userMdoModel">
                                                {{shortName(subscriber.userMdoModel.fName, subscriber.userMdoModel.lName)}}
                                            </div>
                                        </mat-card-header>
                                    </ng-template>

                                    <ng-template #invitedUserProfile>
                                        <mat-card-header>
                                            <div mat-card-avatar>
                                                <mat-icon fontSet="mdo-icons">home-channel2</mat-icon>
                                            </div>
                                        </mat-card-header>
                                    </ng-template>
                                    </div>
        
                                    <div class="col col-x8">
                                        <mat-card-header>
                                            <ng-template [ngIf]="subscriber.userMdoModel && subscriber.isInvited!==true" [ngIfElse]="isInvited">
                                            <mat-card-title *ngIf="subscriber.userMdoModel!==undefined">
                                                {{subscriber.userMdoModel.fName}} {{subscriber.userMdoModel.lName}}
                                            </mat-card-title>
                                            </ng-template>

                                            <ng-template #isInvited>
                                                <mat-card-title>
                                                    {{subscriber.userid}}
                                                </mat-card-title>
                                            </ng-template>
                                        </mat-card-header>
                                    </div>
        
                                    <div class="col col-x4" [matMenuTriggerFor]="subscriberRole">
                                        <lib-button type="minor" icon="caret-down"  iconPosition="before" *ngIf="subscriber.isAdmin" i18n="@@admin"> Admin </lib-button>
                                        <lib-button type="minor" icon="caret-down"  iconPosition="before" *ngIf="subscriber.isReviewer" i18n="@@reviewer"> Reviewer </lib-button>
                                        <lib-button type="minor" icon="caret-down"  iconPosition="before" *ngIf="subscriber.isViewer" i18n="@@viewer"> Viewer </lib-button>
                                        <lib-button type="minor" icon="caret-down"  iconPosition="before" *ngIf="subscriber.isEditer" i18n="@@editor"> Editor </lib-button>
                                        
                                    </div>
                                    <mat-menu #subscriberRole="matMenu" class="navigation-menu">
                                        <button mat-menu-item *ngFor="let role of roles" (click)="updateRole(subscriber, role.code)">{{role.text}}</button>
                                    </mat-menu>
        
                                    <div class="col col-x16">
                                        <mat-chip-list>
                                            <ng-template ngFor let-ctrl [ngForOf]="subscriber.filterCriteria">
        
                                                <mat-chip class="mdo-filter-matchip" disableRipple="true"
                                                    [matMenuTriggerFor]="appliedfiltermenu" (click)="loadDropValues(ctrl)">
                                                    <label>
                                                        {{ ctrl.fldCtrl ? ctrl.fldCtrl.fieldDescri : 'Unknown' }}
                                                        :
                                                    </label>
        
                                                    <span class="info">
                                                        {{ prepareTextToShow(ctrl) }}
                                                    </span>
        
                                                    <mat-icon matChipRemove (click)="removeAppliedFilter(ctrl, subscriber.sno)">
                                                        clear
                                                    </mat-icon>
                                                </mat-chip>
                                            </ng-template>
        
                                            <mat-chip class="mdo-filter-matchip" disableRipple="true"
                                                [matMenuTriggerFor]="addfiltermenu" (click)="reInilize = !reInilize"
                                                *ngIf="subscriber.isInvited!==true">
                                                <mat-icon fontSet="mdo-icons">filter</mat-icon>
                                            </mat-chip>
        
                                        </mat-chip-list>
        
                                        <mat-menu #appliedfiltermenu="matMenu">
                                            <pros-filter-values [moduleId]="moduleId"
                                                (selectedValues)="fetchSelectedValues($event, subscriber.sno)"
                                                [fieldId]="loadDopValuesFor ? loadDopValuesFor.fieldId : ''"
                                                [checkedValue]="loadDopValuesFor ? loadDopValuesFor.checkedValue : []">
                                            </pros-filter-values>
                                        </mat-menu>
        
                                        <mat-menu #addfiltermenu="matMenu">
                                            <pros-add-filter-menu [moduleId]="moduleId"
                                                (evtReadyForApply)="makeFilterControl($event, subscriber.sno)"
                                                [reInilize]="reInilize">
                                            </pros-add-filter-menu>
                                        </mat-menu>
                                    </div>
        
                                    <div class="col">
                                        <lib-button type="plain" (click)="deleteSubscriber(subscriber.sno)" iconFontType="light" icon="trash-alt"></lib-button>
                                    </div>
                                </div>
                            </ng-template>

                            <ng-template #subscriberNullState>
                                <lib-empty-state i18n-primaryText="@@nothing_to_see_here" primaryText="Nothing to see here" i18n-secondaryText="@@subscriber_null_message" [secondaryText]="subscribersNullMessage" icon="table"iconSize="100"></lib-empty-state>
                            </ng-template>
                        </div>
                        <!-- Subscribers listing latest code end here -->
                    </mat-expansion-panel>
                </mat-accordion>
            </div>
        </div>
    </div>
</div>