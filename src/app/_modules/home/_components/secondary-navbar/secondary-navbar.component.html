<div class="root">
  <mat-card class="secondary-card mat-elevation-z0">
    <div class="f-row-spacer-half"></div>
    <div class="f-row secondary-padd-lr">
      <lib-text-line type="leading">{{ getRoutedDescription }}</lib-text-line>
      <span class="f-spacer"></span>
      <lib-button type="plain" iconFontType="light" icon="plus" *ngIf="(activatedPrimaryNav !== 'schema' && activatedPrimaryNav !== 'list'); else isSchema" (click)="globalCreate()"></lib-button>
      <ng-template #isSchema>
        <lib-button type="plain" iconFontType="light" icon="plus" [matMenuTriggerFor]="moduleMenu"
          *ngIf="activatedPrimaryNav !== 'list'"></lib-button>
        <mat-menu #moduleMenu="matMenu" xPosition="before" (closed)="searchInput.clearSearch()" class="navigation-menu">
          <div class="search-row"><lib-search  placeholder="Search for module" (valueChange)="filterModulesMenu($event)" #searchInput prosClickStopPropagation></lib-search></div>
          <div class="menu-customdropdown search-module-dropdown">
            <lib-button class="lib-button" *ngFor="let module of filteredModulesMenu;"
              (click)="createNewSchema(module.moduleId)">{{module.moduleDesc ? module.moduleDesc : 'Untitled'}}
            </lib-button>
          </div>
        </mat-menu>
      </ng-template>
    </div>

    <div class="row-spacer"></div>
    <div class="secondary-padd-lr">
      <lib-search  placeholder="Search" #schemaSearchInput (valueChange)=(searchSchema($event))></lib-search>
    <!-- placeholder="activatedPrimaryNav ==='report' ? 'Search report' : activatedPrimaryNav ==='list'? 'Search' :'Search schema'" -->
    </div>
    
    
    <div class="row-spacer"></div>

    <div class="nav-tree" id="nav-tree">
      <mat-accordion *ngIf="activatedPrimaryNav === 'welcome' || showTasksList">
      <!-- <mat-accordion> -->
        <lib-section text="Tasks" *ngIf="taskList.length"></lib-section>
        <div cdkDropList class="dnd-tasks-list" (cdkDropListDropped)="dropTask($event)">
          <ng-container *ngFor="let task of taskList; let i=index">
            <div cdkDrag  class="tasks-list-drag-el" cdkDragBoundary=".dnd-tasks-list">
              <mat-expansion-panel hideToggle="{{ (task.childs && task.childs.length) ? 'false' : 'true' }}" togglePosition="before" class="mat-elevation-z0" [id]="task.id" [expanded]="(task.id === selectedTask) && selectedTaskFilter">
                <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px" [routerLink]="['/home/task', task.id, 'feed']" [class.selected] = "!selectedTaskFilter && (task.id === selectedTask)" (click)="updateTaskState(task.id)">
                  <mat-panel-title>
                    <div class="expand-title">{{task.label}}</div>
                    <span class="f-spacer"></span>
                    <div *ngIf="!task.hasNewFeeds && task.rec_cnt" class="badge">{{ task.rec_cnt }}</div>
                    <lib-button *ngIf="task.hasNewFeeds && task.new_feed_cnt" [libBadge]="task.new_feed_cnt" matBadgePosition="below" matBadgeSize="medium" matBadgeOverlap="true" class="task-badge btn-pos"></lib-button>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <mat-nav-list [disableRipple]="true" class="dnd-task-search-list">
                  <div cdkDropList (cdkDropListDropped)="dropTask($event, i)">
                    <mat-list-item *ngFor="let subTask of task.childs" [class.selected] = "subTask.id === selectedTaskFilter">
                      <div cdkDrag class="task-search-list-drag-el" cdkDragBoundary=".dnd-task-search-list" [routerLink]="['/home/task', task.id, 'feed']" [queryParams]="{ s: subTask.id}"  (click)="updateTaskState(task.id, subTask.id)">
                        <div mat-line>{{ subTask.label }}</div>
                        <span class="f-spacer"></span>
                        <span *ngIf="!subTask.hasNewFeeds && subTask.rec_cnt">{{ subTask.rec_cnt }}</span>
                        <lib-button *ngIf="subTask.hasNewFeeds && subTask.new_feed_cnt" [libBadge]="subTask.new_feed_cnt" matBadgePosition="below" matBadgeSize="medium" class="task-badge search-badge"></lib-button>
                      </div>
                    </mat-list-item>
                  </div>
                </mat-nav-list>
              </mat-expansion-panel>
            </div>
          </ng-container>
        </div>
      </mat-accordion>

      <!-- Tree to show when navigation is on HOME -->
      <mat-accordion *ngIf="activatedPrimaryNav === 'welcome'">
        <lib-section text="Data intelligence"></lib-section>
        <ng-container *ngFor="let module of searchModuleResults">
          <mat-expansion-panel togglePosition="before" class="mat-elevation-z0"
            *ngIf="module.schemaLists && module.schemaLists.length>0">
            <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
              <mat-panel-title>
                <div class="expand-title">{{module.moduleDesc ? module.moduleDesc : 'Untitled'}}</div>
                <span class="f-spacer"></span>
                <div class="badge">{{module.schemaLists.length}}</div>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-nav-list role="navigation" [disableRipple]="true">
              <mat-list-item *ngFor="let schema of module.schemaLists"
                [routerLink]="['schema/schema-details', module.moduleId, schema.schemaId]"
                [routerLinkActive]="'selected'">
                <div mat-line>{{schema.schemaDescription ?  schema.schemaDescription : 'Untitled'}}</div>
                <span class="f-spacer"></span>
                <lib-spinner *ngIf="schema.isInRunning" size="24"></lib-spinner>
              </mat-list-item>
            </mat-nav-list>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>

      <!-- Tree to show when navigation is on schema -->
      <mat-accordion *ngIf="activatedPrimaryNav === 'schema'">
        <ng-container *ngFor="let module of searchModuleResults">
          <mat-expansion-panel togglePosition="before" class="mat-elevation-z0"
            [expanded]="activeMenuItemId === module.moduleId"
            *ngIf="module.schemaLists && module.schemaLists.length>0"
            [id]="module.moduleId">
            <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px"
              [routerLink]="['schema', module.moduleId]">
              <mat-panel-title>
                <div class="expand-title">{{module.moduleDesc ? module.moduleDesc : 'Untitled'}}</div>
                <span class="f-spacer"></span>
                <div class="badge">{{module.schemaLists.length}}</div>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-nav-list role="navigation" [disableRipple]="true">
              <mat-list-item *ngFor="let schema of module.schemaLists"
                [routerLink]="['schema/schema-info', schema.moduleId, schema.schemaId]"
                [ngClass]="{'selected' : isActiveLink('schema/schema-info/' + schema.moduleId + '/' + schema.schemaId)}"
                [queryParams]="{fragment:'business-rules'}">
                <div mat-line>{{schema.schemaDescription ?  schema.schemaDescription : 'Untitled'}}</div>
              </mat-list-item>
            </mat-nav-list>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>

      <!-- Tree to show when navigation is on report -->
      <mat-accordion *ngIf="activatedPrimaryNav === 'report'">
        <mat-nav-list *ngFor="let report of reportOb | async" [disableRipple]="true">
          <mat-list-item [disabled]="report.permission && !report.permission.isViewable"
            [routerLink]="['report/dashboard', report.reportId]" [routerLinkActive]="'selected'">
            <div #headingTitle class="heading-title"
            [libTooltip]="report.reportName" matTooltipPosition="right"
            [matTooltipDisabled]="isTooltipReady && !(headingTitle.offsetWidth < headingTitle.scrollWidth)">{{report.reportName ? report.reportName : 'Untitled'}}</div>
          </mat-list-item>
        </mat-nav-list>
      </mat-accordion>

      <!-- Tree to show when navigation is on list -->
      <mat-accordion *ngIf="activatedPrimaryNav === 'list'" cdkDropList [cdkDropListData]="objectTypeList" (cdkDropListDropped)="drop($event)">
        <mat-nav-list *ngFor="let objectType of objectTypeObs | async" cdkDrag [disableRipple]="true">
          <mat-list-item cdkDragHandle 
          [routerLink]="['list/datatable', objectType.objectid]"
          routerLinkActive="selected">
              {{objectType.objectdesc ? objectType.objectdesc : 'Untitled'}}
          </mat-list-item>
        </mat-nav-list>
      </mat-accordion>
    </div>
  </mat-card>

  <div class="split-col" (click)="toggleSideBar()">
    <div class="split-arrow">
      <mat-icon fontSet="mdo-icons">{{secondarySideBarOpened ? 'chevron-left' : 'chevron-right'}}</mat-icon>
    </div>
  </div>
</div>